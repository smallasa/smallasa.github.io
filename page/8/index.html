<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>smallasa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="smallasa">
<meta property="og:url" content="http://www.smallasa.com/page/8/index.html">
<meta property="og:site_name" content="smallasa">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="smallasa">
  
    <link rel="alternate" href="/atom.xml" title="smallasa" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">smallasa</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">I known what i do !</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.smallasa.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-salt-install-HA" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/04/salt-install-HA/" class="article-date">
  <time datetime="2017-08-04T05:09:37.000Z" itemprop="datePublished">2017-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/automation/">automation</a>►<a class="article-category-link" href="/categories/automation/salt/">salt</a>►<a class="article-category-link" href="/categories/automation/salt/salt-install-HA/">salt install HA</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/04/salt-install-HA/">salt install HA</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="salt-multiple-master-syndic-minion"><a href="#salt-multiple-master-syndic-minion" class="headerlink" title="salt multiple master/syndic/minion"></a>salt multiple master/syndic/minion</h3><p>1.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/08/04/salt-install-HA/" data-id="cjavy9k60009u0coqqm5wx06g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-salt-install-standard" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/04/salt-install-standard/" class="article-date">
  <time datetime="2017-08-04T05:08:25.000Z" itemprop="datePublished">2017-08-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/automation/">automation</a>►<a class="article-category-link" href="/categories/automation/salt/">salt</a>►<a class="article-category-link" href="/categories/automation/salt/salt-install-standard/">salt install standard</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/04/salt-install-standard/">salt install standard</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="salt-master-minion-install"><a href="#salt-master-minion-install" class="headerlink" title="salt master/minion install"></a>salt master/minion install</h3><ol>
<li><p>env init</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">//机器信息</span><br><span class="line">192.168.13.188 saltserver  <span class="comment"># CentOS 7.0</span></span><br><span class="line">192.168.13.187 saltminion  <span class="comment"># CentOS 6.5</span></span><br><span class="line"></span><br><span class="line">//salt-master</span><br><span class="line">[root@localhost ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.0.1406 (Core)</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># hostname saltserver &amp;&amp; echo saltserver |tee /etc/hostname</span></span><br><span class="line">[root@localhost ~]<span class="comment"># $SHELL</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># echo '192.168.13.188 saltserver' |tee -a /etc/hosts    </span></span><br><span class="line">[root@saltserver ~]<span class="comment"># echo '192.168.13.187 saltminion' |tee -a /etc/hosts</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># mkfs.xfs /dev/vdb</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># echo '/dev/vdb /mnt xfs defaults 0 0' | tee -a /etc/fstab</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># mount -a</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># echo '* - nproc  65535' | tee -a /etc/security/limits.conf</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># echo '* - nofile 65535' | tee -a /etc/security/limits.conf</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># ls /etc/security/limits.d/|xargs rm -f</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># mkdir /etc/yum.repos.d/backup &amp;&amp; mv /etc/yum.repos.d/&#123;*,backup&#125;</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># curl -o /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># curl -O https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># rpm --import RPM-GPG-KEY-CentOS-7</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># rm -f RPM-GPG-KEY-CentOS-7</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># yum clean all</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># yum makecache</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># yum -y install gcc gcc-c++ make cmake bison libtool autoconf automake zip unzip bzip2 zlib zlib-devel openssl openssl-devel openssl-static pcre pcre-devel bison-devel ncurses-devel tcl tcl-devel perl-Digest-SHA1 GeoIP GeoIP-devel gperftools gperftools-devel libatomic_ops-devel gtest gtest-devel glibc-devel unixODBC-devel fop libperl libpython readline readline-devel python-devel python2-pip python-crypto readline readline-devel readline-static sqlite-devel bzip2-devel bzip2-libs openldap-devel gdk-pixbuf2 gdk-pixbuf2-devel libffi libffi-devel libcurl libcurl-devel http-parser http-parser-devel libssh2 libssh2-devel git lftp ntp ntpdate vim wget telnet dstat tree lrzsz net-tools nmap-ncat nmap sysstat</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># sed -i s/'SELINUX=enforcing'/'SELINUX=disabled'/g /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># [ -f /etc/localtime ] &amp;&amp; cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># [ -f /etc/sysconfig/clock ] &amp;&amp; echo 'ZONE="Asia/Shanghai"' | tee /etc/sysconfig/clock</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># [ -f /etc/timezone ] &amp;&amp; echo 'Asia/Shanghai' | tee /etc/timezone</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># [ -f /etc/sysconfig/ntpd ] &amp;&amp; echo 'SYNC_HWCLOCK=yes' | tee -a /etc/sysconfig/ntpd</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># ntpdate cn.pool.ntp.org</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># cp -f /etc/&#123;ntp.conf,ntp.conf.bak&#125;</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># cat &gt; /etc/ntp.conf &lt;&lt;EOF</span></span><br><span class="line">&gt; driftfile /var/lib/ntp/drift</span><br><span class="line">&gt; restrict default nomodify notrap nopeer noquery</span><br><span class="line">&gt; restrict 127.0.0.1</span><br><span class="line">&gt; restrict ::1</span><br><span class="line">&gt; server cn.pool.ntp.org prefer</span><br><span class="line">&gt; server 0.centos.pool.ntp.org iburst</span><br><span class="line">&gt; server 1.centos.pool.ntp.org iburst</span><br><span class="line">&gt; server 2.centos.pool.ntp.org iburst</span><br><span class="line">&gt; server 3.centos.pool.ntp.org iburst</span><br><span class="line">&gt; includefile /etc/ntp/crypto/pw</span><br><span class="line">&gt; keys /etc/ntp/keys</span><br><span class="line">&gt; <span class="built_in">disable</span> monitor</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltserver ~]<span class="comment"># cp -f /etc/ntp/&#123;step-tickers,step-tickers.bak&#125;</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># cat &gt; /etc/ntp/step-tickers &lt;&lt;EOF</span></span><br><span class="line">&gt; cn.pool.ntp.org</span><br><span class="line">&gt; 0.centos.pool.ntp.org</span><br><span class="line">&gt; 1.centos.pool.ntp.org</span><br><span class="line">&gt; 2.centos.pool.ntp.org</span><br><span class="line">&gt; 3.centos.pool.ntp.org</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltserver ~]<span class="comment"># systemctl start ntpd &amp;&amp; systemctl enable ntpd</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># mkdir -p /mnt/&#123;app,data,log,web,ops/&#123;app,data,cron&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># mkdir ~/.pip</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># cat &gt; ~/.pip/pip.conf &lt;&lt;EOF</span></span><br><span class="line">&gt; [global]</span><br><span class="line">&gt; trusted-host=mirrors.aliyun.com</span><br><span class="line">&gt; index-url=http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">&gt; [list]</span><br><span class="line">&gt; format=columns</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltserver ~]<span class="comment"># pip install --upgrade pip</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># python -V</span></span><br><span class="line">Python 2.7.5</span><br><span class="line"></span><br><span class="line">[root@saltserver app]<span class="comment"># wget https://www.python.org/ftp/python/2.7.13/Python-2.7.13.tar.xz</span></span><br><span class="line">[root@saltserver app]<span class="comment"># xz -d Python-2.7.13.tar.xz</span></span><br><span class="line">[root@saltserver app]<span class="comment"># tar xf Python-2.7.13.tar</span></span><br><span class="line">[root@saltserver app]<span class="comment"># cd Python-2.7.13</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># ./configure --prefix=/usr/local/python27</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># make</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># make install</span></span><br><span class="line"></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># wget https://bootstrap.pypa.io/get-pip.py</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># /usr/local/python27/bin/python get-pip.py</span></span><br><span class="line"></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># echo 'export PYTHON_PATH=/usr/local/python27' |tee /etc/profile.d/python27.sh</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># echo 'export PYTHON_BIN=$PYTHON_PATH/bin' |tee -a /etc/profile.d/python27.sh</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># echo 'export PATH=$PYTHON_BIN:$PATH' |tee -a /etc/profile.d/python27.sh</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># source /etc/profile</span></span><br><span class="line"></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># rm -f /usr/bin/&#123;python,pip&#125;</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># sed -i s/python/python2.7/g /usr/bin/yum</span></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># sed -i s/python/python2.7/g /usr/libexec/urlgrabber-ext-down</span></span><br><span class="line"></span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># python -V</span></span><br><span class="line">Python 2.7.13</span><br><span class="line">[root@saltserver Python-2.7.13]<span class="comment"># pip -V</span></span><br><span class="line">pip 9.0.1 from /usr/<span class="built_in">local</span>/python27/lib/python2.7/site-packages (python 2.7)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//salt-minion</span><br><span class="line">[root@localhost ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS release 6.5 (Final)</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># hostname saltminion &amp;&amp; echo saltminion |tee /etc/hostname</span></span><br><span class="line">[root@localhost ~]<span class="comment"># $SHELL</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># echo '192.168.13.188 saltserver' |tee -a /etc/hosts</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># echo '192.168.13.187 saltminion' |tee -a /etc/hosts</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># mkfs.xfs /dev/vdb</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># echo '/dev/vdb /mnt xfs defaults 0 0' | tee -a /etc/fstab</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># mount -a</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># echo '* - nproc  65535' | tee -a /etc/security/limits.conf</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># echo '* - nofile 65535' | tee -a /etc/security/limits.conf</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># ls /etc/security/limits.d/|xargs rm -f</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># mkdir /etc/yum.repos.d/backup &amp;&amp; mv /etc/yum.repos.d/&#123;*,backup&#125;</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># curl -o /etc/yum.repos.d/epel-6.repo http://mirrors.aliyun.com/repo/epel-6.repo</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># curl -O https://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-6</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># rpm --import RPM-GPG-KEY-CentOS-6</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># rm -f RPM-GPG-KEY-CentOS-6</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># yum clean all</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># yum makecache</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># yum groupinstall "Development tools"</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># yum -y install gcc gcc-c++ make cmake bison libtool autoconf automake zip unzip bzip2 zlib zlib-devel openssl openssl-devel openssl-static pcre pcre-devel bison-devel ncurses-devel tcl tcl-devel perl-Digest-SHA1 GeoIP GeoIP-devel gperftools gperftools-devel libatomic_ops-devel gtest gtest-devel glibc-devel unixODBC-devel fop libperl libpython readline readline-devel python-devel python2-pip python-crypto readline readline-static sqlite-devel bzip2-devel bzip2-libs openldap-devel gdk-pixbuf2 gdk-pixbuf2-devel libffi libffi-devel libcurl libcurl-devel http-parser http-parser-devel libssh2 libssh2-devel tk-devel gdbm-devel db4-devel libpcap-devel xz xz-devel git lftp ntp ntpdate vim wget telnet dstat tree lrzsz net-tools nmap-ncat nmap sysstat</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># sed -i s/'SELINUX=enforcing'/'SELINUX=disabled'/g /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># /etc/init.d/iptables stop &amp;&amp; chkconfig iptables off</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># [ -f /etc/localtime ] &amp;&amp; cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># [ -f /etc/sysconfig/clock ] &amp;&amp; echo 'ZONE="Asia/Shanghai"' | tee /etc/sysconfig/clock</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># [ -f /etc/timezone ] &amp;&amp; echo 'Asia/Shanghai' | tee /etc/timezone</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># [ -f /etc/sysconfig/ntpd ] &amp;&amp; echo 'SYNC_HWCLOCK=yes' | tee -a /etc/sysconfig/ntpd</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># ntpdate cn.pool.ntp.org</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># cp -f /etc/&#123;ntp.conf,ntp.conf.bak&#125;</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># cat &gt; /etc/ntp.conf &lt;&lt;EOF</span></span><br><span class="line">&gt; driftfile /var/lib/ntp/drift</span><br><span class="line">&gt; restrict default nomodify notrap nopeer noquery</span><br><span class="line">&gt; restrict 127.0.0.1</span><br><span class="line">&gt; restrict ::1</span><br><span class="line">&gt; server cn.pool.ntp.org prefer</span><br><span class="line">&gt; server 0.centos.pool.ntp.org iburst</span><br><span class="line">&gt; server 1.centos.pool.ntp.org iburst</span><br><span class="line">&gt; server 2.centos.pool.ntp.org iburst</span><br><span class="line">&gt; server 3.centos.pool.ntp.org iburst</span><br><span class="line">&gt; includefile /etc/ntp/crypto/pw</span><br><span class="line">&gt; keys /etc/ntp/keys</span><br><span class="line">&gt; <span class="built_in">disable</span> monitor</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltminion ~]<span class="comment"># cp -f /etc/ntp/&#123;step-tickers,step-tickers.bak&#125;</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># cat &gt; /etc/ntp/step-tickers &lt;&lt;EOF</span></span><br><span class="line">&gt; cn.pool.ntp.org</span><br><span class="line">&gt; 0.centos.pool.ntp.org</span><br><span class="line">&gt; 1.centos.pool.ntp.org</span><br><span class="line">&gt; 2.centos.pool.ntp.org</span><br><span class="line">&gt; 3.centos.pool.ntp.org</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltminion ~]<span class="comment"># /etc/init.d/ntpd start &amp;&amp; chkconfig ntpd on</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># mkdir -p /mnt/&#123;app,data,log,web,ops/&#123;app,data,cron&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># mkdir ~/.pip</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># cat &gt; ~/.pip/pip.conf &lt;&lt;EOF</span></span><br><span class="line">&gt; [global]</span><br><span class="line">&gt; trusted-host=mirrors.aliyun.com</span><br><span class="line">&gt; index-url=http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">&gt; [list]</span><br><span class="line">&gt; format=columns</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltminion ~]<span class="comment"># python -V</span></span><br><span class="line">Python 2.6.6</span><br><span class="line"></span><br><span class="line">[root@saltminion app]<span class="comment"># wget https://www.python.org/ftp/python/2.7.13/Python-2.7.13.tar.xz</span></span><br><span class="line">[root@saltminion app]<span class="comment"># xz -d Python-2.7.13.tar.xz</span></span><br><span class="line">[root@saltminion app]<span class="comment"># tar xf Python-2.7.13.tar</span></span><br><span class="line">[root@saltminion app]<span class="comment"># cd Python-2.7.13</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># ./configure --prefix=/usr/local/python27</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># make</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># make install</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># wget https://bootstrap.pypa.io/get-pip.py</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># echo 'export PYTHON_PATH=/usr/local/python27' |tee /etc/profile.d/python27.sh</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># echo 'export PYTHON_BIN=$PYTHON_PATH/bin' |tee -a /etc/profile.d/python27.sh</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># echo 'export PATH=$PYTHON_BIN:$PATH' |tee -a /etc/profile.d/python27.sh</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># rm -f /usr/bin/&#123;python,pip&#125;</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># sed -i s/python/python2.6/g /usr/bin/yum</span></span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># python -V</span></span><br><span class="line">Python 2.7.13</span><br><span class="line">[root@saltminion Python-2.7.13]<span class="comment"># pip -V</span></span><br><span class="line">pip 9.0.1 from /usr/<span class="built_in">local</span>/python27/lib/python2.7/site-packages (python 2.7)</span><br></pre></td></tr></table></figure>
</li>
<li><p>salt master/minion install</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//salt-master</span><br><span class="line">[root@saltserver ~]<span class="comment"># pip install salt</span></span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># mkdir -p /etc/salt</span></span><br><span class="line">[root@saltserver ~]<span class="comment"># cat &gt; /etc/salt/master &lt;&lt;EOF</span></span><br><span class="line">&gt; interface: 0.0.0.0</span><br><span class="line">&gt; ipv6: False</span><br><span class="line">&gt; publish_port: 4505</span><br><span class="line">&gt; ret_port: 4506</span><br><span class="line">&gt; user: root</span><br><span class="line">&gt; EOF</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt-master -c /etc/salt -d  //启动master</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//salt-minon</span><br><span class="line">[root@saltminion ~]<span class="comment"># pip install salt</span></span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># mkdir -p /etc/salt</span></span><br><span class="line">[root@saltminion ~]<span class="comment"># cat &gt; /etc/salt/minion &lt;&lt;EOF</span></span><br><span class="line">&gt; master: 192.168.13.188</span><br><span class="line">&gt; master_port: 4506</span><br><span class="line">&gt; user: root</span><br><span class="line">&gt; id: 192.168.13.187</span><br><span class="line">&gt; EOF</span><br><span class="line"></span><br><span class="line">[root@saltminion ~]<span class="comment"># salt-minion -c /etc/salt -d  //启动minion</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>salt master与minion 建立连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//salt-master 查看秘钥</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt-key -L</span></span><br><span class="line">Accepted Keys:</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">192.168.13.187</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">//salt-master 查看 minion 秘钥信息</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt-key -f 192.168.13.187</span></span><br><span class="line">Unaccepted Keys:</span><br><span class="line">192.168.13.187:  34:6d:95:cf:17:98:<span class="built_in">fc</span>:cf:99:2d:0f:2d:e9:ec:f8:95:ac:00:ba:f7:6c:71:ab:cf:aa:4a:05:7e:8c:04:97:81</span><br><span class="line">//salt-minion 查看 minion 秘钥信息</span><br><span class="line">[root@saltminion ~]<span class="comment"># salt-call --local key.finger</span></span><br><span class="line"><span class="built_in">local</span>:</span><br><span class="line">    34:6d:95:cf:17:98:<span class="built_in">fc</span>:cf:99:2d:0f:2d:e9:ec:f8:95:ac:00:ba:f7:6c:71:ab:cf:aa:4a:05:7e:8c:04:97:81</span><br><span class="line"></span><br><span class="line">//salt-master 接受 minion 秘钥认证</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt-key -a 192.168.13.187</span></span><br><span class="line">The following keys are going to be accepted:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">192.168.13.187</span><br><span class="line">Proceed? [n/Y] Y</span><br><span class="line">Key <span class="keyword">for</span> minion 192.168.13.187 accepted.</span><br><span class="line"></span><br><span class="line">[root@saltserver ~]<span class="comment"># salt-key -L</span></span><br><span class="line">Accepted Keys:</span><br><span class="line">192.168.13.187</span><br><span class="line">Denied Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">Rejected Keys:</span><br><span class="line"></span><br><span class="line">//salt-master 自动签发证书</span><br><span class="line">方法一:</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'auto_accept: True'</span> |tee -a /etc/salt/master</span><br><span class="line">方法二:</span><br><span class="line">salt-key -A -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>salt-master测试指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">//salt-master 给 所有的minion 发送指令</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt '*' test.ping</span></span><br><span class="line">192.168.13.187:</span><br><span class="line">    True</span><br><span class="line"></span><br><span class="line">//salt-master 查找 minion <span class="built_in">test</span> 函数列表</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt '192.168.13.187' sys.list_functions test</span></span><br><span class="line">192.168.13.187:</span><br><span class="line">    - test.arg</span><br><span class="line">    - test.arg_repr</span><br><span class="line">    - test.arg_type</span><br><span class="line">    - test.assertion</span><br><span class="line">    - test.attr_call</span><br><span class="line">    - test.collatz</span><br><span class="line">    - test.conf_test</span><br><span class="line">    - test.cross_test</span><br><span class="line">    - test.echo</span><br><span class="line">    - test.exception</span><br><span class="line">    - test.false</span><br><span class="line">    - test.fib</span><br><span class="line">    - test.get_opts</span><br><span class="line">    - test.kwarg</span><br><span class="line">    - test.module_report</span><br><span class="line">    - test.not_loaded</span><br><span class="line">    - test.opts_pkg</span><br><span class="line">    - test.outputter</span><br><span class="line">    - test.ping</span><br><span class="line">    - test.provider</span><br><span class="line">    - test.providers</span><br><span class="line">    - test.rand_sleep</span><br><span class="line">    - test.rand_str</span><br><span class="line">    - test.retcode</span><br><span class="line">    - test.sleep</span><br><span class="line">    - test.stack</span><br><span class="line">    - test.true</span><br><span class="line">    - test.try_</span><br><span class="line">    - test.tty</span><br><span class="line">    - test.version</span><br><span class="line">    - test.versions</span><br><span class="line">    - test.versions_information</span><br><span class="line">    - test.versions_report</span><br><span class="line"></span><br><span class="line">//salt-master 查找 minion <span class="built_in">test</span> 函数使用方法</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt '192.168.13.187' sys.doc test.echo</span></span><br><span class="line">test.echo:</span><br><span class="line">    Return a string - used <span class="keyword">for</span> testing the connection</span><br><span class="line">    CLI Example:</span><br><span class="line">        salt <span class="string">'*'</span> test.echo <span class="string">'foo bar baz quo qux'</span></span><br><span class="line"></span><br><span class="line">//salt-master 执行 minion <span class="built_in">test</span> 函数</span><br><span class="line">[root@saltserver ~]<span class="comment"># salt '192.168.13.187' test.echo 'Hello WOrld!'</span></span><br><span class="line">192.168.13.187:</span><br><span class="line">    Hello WOrld!</span><br></pre></td></tr></table></figure>
</li>
<li><p>salt 远程执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line">salt [options] &apos;&lt;target&gt;&apos; &lt;function&gt; [arguments]</span><br><span class="line">说明:</span><br><span class="line">* 第一部分,salt命令本身</span><br><span class="line">* 第二部分,命令行选项</span><br><span class="line">* 第三部分,目标定位字符串</span><br><span class="line">* 第四部分,slat模块函数</span><br><span class="line">* 第五部分,远程执行函数参数</span><br><span class="line"></span><br><span class="line">例如:</span><br><span class="line">[root@saltserver ~]# salt --summary &apos;192.168.13.187&apos; cmd.run &apos;uptime&apos;</span><br><span class="line">192.168.13.187:</span><br><span class="line">     14:39:06 up  5:17,  1 user,  load average: 2.00, 1.93, 1.30</span><br><span class="line">-------------------------------------------</span><br><span class="line">Summary</span><br><span class="line">-------------------------------------------</span><br><span class="line"># of minions targeted: 1</span><br><span class="line"># of minions returned: 1</span><br><span class="line"># of minions that did not return: 0</span><br><span class="line"># of minions with errors: 0</span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//第二部分,命令行选项</span><br><span class="line">* -v,--verbose 描述命令执行后,会发生什么(命令执行过程)</span><br><span class="line">[root@saltserver ~]# salt --verbose &apos;*&apos; cmd.run_all &quot;echo my salt&quot;</span><br><span class="line">Executing job with jid 20170804144256968580</span><br><span class="line">-------------------------------------------</span><br><span class="line">192.168.13.187:</span><br><span class="line">    ----------</span><br><span class="line">    pid:</span><br><span class="line">        26067</span><br><span class="line">    retcode:</span><br><span class="line">        0</span><br><span class="line">    stderr:</span><br><span class="line">    stdout:</span><br><span class="line">        my salt</span><br><span class="line"></span><br><span class="line">* --summary 显示salt命令概要</span><br><span class="line">[root@saltserver ~]# salt --summary &apos;*&apos; cmd.run_all &quot;echo my salt&quot;</span><br><span class="line">192.168.13.187:</span><br><span class="line">    ----------</span><br><span class="line">    pid:</span><br><span class="line">        26073</span><br><span class="line">    retcode:</span><br><span class="line">        0</span><br><span class="line">    stderr:</span><br><span class="line">    stdout:</span><br><span class="line">        my salt</span><br><span class="line">-------------------------------------------</span><br><span class="line">Summary</span><br><span class="line">-------------------------------------------</span><br><span class="line"># of minions targeted: 1</span><br><span class="line"># of minions returned: 1</span><br><span class="line"># of minions that did not return: 0</span><br><span class="line"># of minions with errors: 0</span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line">* --out 控制salt执行后的输出格式</span><br><span class="line">[root@saltserver ~]# salt --out=json &apos;*&apos; cmd.run_all &quot;echo my salt&quot;        </span><br><span class="line">&#123;</span><br><span class="line">    &quot;192.168.13.187&quot;: &#123;</span><br><span class="line">        &quot;pid&quot;: 26079,</span><br><span class="line">        &quot;retcode&quot;: 0,</span><br><span class="line">        &quot;stderr&quot;: &quot;&quot;,</span><br><span class="line">        &quot;stdout&quot;: &quot;my salt&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@saltserver ~]# salt --out=yaml &apos;*&apos; cmd.run_all &quot;echo my salt&quot;    </span><br><span class="line">192.168.13.187:</span><br><span class="line">  pid: 26085</span><br><span class="line">  retcode: 0</span><br><span class="line">  stderr: &apos;&apos;</span><br><span class="line">  stdout: my salt</span><br><span class="line">[root@saltserver ~]# salt --out=raw &apos;*&apos; cmd.run_all &quot;echo my salt&quot;    </span><br><span class="line">&#123;&apos;192.168.13.187&apos;: &#123;&apos;pid&apos;: 26091, &apos;retcode&apos;: 0, &apos;stderr&apos;: &apos;&apos;, &apos;stdout&apos;: &apos;my salt&apos;&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//第三部分,目标定位字符串</span><br><span class="line">* 全局匹配</span><br><span class="line">  *  任意字符,可以是空字符串</span><br><span class="line">  ?  一个字符,不可以是空字符串</span><br><span class="line">  [] 字符集合</span><br><span class="line"></span><br><span class="line">  例如:</span><br><span class="line">  salt &apos;*&apos; test.ping</span><br><span class="line">  salt &apos;192.168.13.*&apos; test.ping</span><br><span class="line">  salt &apos;minion[a-z]&apos; test.ping</span><br><span class="line"></span><br><span class="line">* 正则表达式匹配</span><br><span class="line">  abc  匹配自身abc</span><br><span class="line">  .    匹配任意字符(除换行符)</span><br><span class="line">  \    转义字符</span><br><span class="line">  [..] 字符集,匹配字符集中的任意一个字符</span><br><span class="line">  \d   匹配数字[0-9]</span><br><span class="line">  \D   匹配非数字[^\d]</span><br><span class="line">  \s   匹配空白字符[&lt;空格&gt;\n\t\r\v\f]</span><br><span class="line">  \S   匹配非空字符[^\s]</span><br><span class="line">  \w   匹配单词字符[a-zA-Z0-9]</span><br><span class="line">  \W   匹配非单词字符[^\w]</span><br><span class="line">  *    匹配前一个字符0次或无限次</span><br><span class="line">  +    匹配前一个字符1次或无限次</span><br><span class="line">  ?    匹配前一个字符0次或1次</span><br><span class="line">  &#123;m&#125;  匹配前一个字符m次</span><br><span class="line">  &#123;m,n&#125; 匹配前一个字符m到n次</span><br><span class="line">  ^    匹配字符串开头</span><br><span class="line">  $    匹配字符串结尾</span><br><span class="line">  |    逻辑或</span><br><span class="line">  (..) 表达式分组,作为一个整体</span><br><span class="line">  (?P&lt;name&gt;...) 指定别名</span><br><span class="line">  (?P&lt;name&gt;) 引用别名</span><br><span class="line"></span><br><span class="line">  例如:</span><br><span class="line">  salt -E &apos;minion&apos; test.ping</span><br><span class="line">  salt -E &apos;.*&apos; test.ping</span><br><span class="line">  salt -E &apos;^minion-*&apos; test.ping</span><br><span class="line">  salt -E &apos;*-minion$&apos; test.ping</span><br><span class="line"></span><br><span class="line">* 列表匹配</span><br><span class="line">  salt -L &apos;minion1&apos; test.ping</span><br><span class="line">  salt -L &apos;minion1,minion2,minion3&apos; test.ping</span><br><span class="line"></span><br><span class="line">  配置文件中定义nodegroups:</span><br><span class="line">  /etc/salt/master:</span><br><span class="line">  modegroups:</span><br><span class="line">    minions:</span><br><span class="line">      - minion1</span><br><span class="line">      - minion2</span><br><span class="line">  salt -N minions test.ping</span><br><span class="line"></span><br><span class="line">* grain 和 pillar 匹配</span><br><span class="line">  grain和pillar都是以key/value形式存储的数据库</span><br><span class="line">  grain是由minion返回给master的数据;而pillar是存储在master上的数据</span><br><span class="line">  每个minion可以看到自己的pillar,grain可以看做是主机的元数据(metadata)</span><br><span class="line">  换言之,一个minion可以告诉master自己的grain数据,而minion需要从master索取pillar数据</span><br><span class="line"></span><br><span class="line">  * grains</span><br><span class="line">    grains可以认为是描述minion本身固有属性的静态数据</span><br><span class="line">    例如:</span><br><span class="line">    //检索所有属性</span><br><span class="line">    [root@saltserver ~]# salt --out=yaml &apos;192.168.13.187&apos; grains.items</span><br><span class="line"></span><br><span class="line">    //检索os属性</span><br><span class="line">    [root@saltserver ~]# salt --out=yaml &apos;192.168.13.187&apos; grains.item os</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;192.168.13.187&quot;: &#123;</span><br><span class="line">            &quot;os&quot;: &quot;CentOS&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //通过grain定位主机</span><br><span class="line">    [root@saltserver ~]# salt -G &apos;os:CentOS&apos; test.ping</span><br><span class="line">    192.168.13.187:</span><br><span class="line">      True</span><br><span class="line"></span><br><span class="line">    //自定义grain</span><br><span class="line">    [root@saltserver ~]# salt &apos;192.168.13.187&apos; grains.setval cpu_num 8</span><br><span class="line">    or:</span><br><span class="line">    [root@saltserver ~]# salt &apos;192.168.13.187&apos; grains.setval cpu_info [&apos;Intel&apos;,&apos;Xeon&apos;,&apos;8&apos;]</span><br><span class="line"></span><br><span class="line">    //删除自定义grain</span><br><span class="line">    [root@saltserver ~]# salt &apos;192.168.13.187&apos; grains.delval cpu_info</span><br><span class="line">    注意: 自定义grain一般存储在&quot;/etc/salt/grains&quot;文件中,修改该文件,删除自定义内容,重启salt-minion服务</span><br><span class="line"></span><br><span class="line">  * pillar</span><br><span class="line">    pillars数据类似grains,不同之处在于pillars数据可以定义为更加动态的形式,并且是一个安全的数据库</span><br><span class="line">    例如:</span><br><span class="line">    //列出主机所有pillar数据</span><br><span class="line">    [root@saltserver ~]# salt &apos;192.168.13.187&apos; pillar.items</span><br><span class="line">    192.168.13.187:</span><br><span class="line">      ----------</span><br><span class="line"></span><br><span class="line">    //查看单个数据命令</span><br><span class="line">    [root@saltserver ~]# salt &apos;192.168.13.187&apos; pillar.item role</span><br><span class="line"></span><br><span class="line">    //pillar定位主机</span><br><span class="line">    [root@saltserver ~]# salt -I &apos;role:web&apos; test.ping</span><br><span class="line"></span><br><span class="line">* 复合匹配</span><br><span class="line">  G  G@os:CentOS</span><br><span class="line">  E  E@web\d+\(dev|qa|prod)\.loc</span><br><span class="line">  P  P@os:(redhat|centos|fedora)</span><br><span class="line">  L  L@minion1,minion2,minion3</span><br><span class="line">  I  I@pdata:foobar</span><br><span class="line">  S  S@192.168.1.0/24 or S@192.168.1.100</span><br><span class="line">  R  R@%foo.bar</span><br><span class="line"></span><br><span class="line">  例如:</span><br><span class="line">  salt -C &apos;minion-* and G@os:CentOS not E@.*-two$&apos; test.ping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//第四部分,slat模块函数 和 第五部分,远程执行函数参数</span><br><span class="line">远程执行模块构成:</span><br><span class="line">远程执行命令的最后一部分是我们需要运行的模块以及相关函数和对应的执行参数</span><br><span class="line">模块可以认为是函数的逻辑分组,一系列的函数组合在一起构成一个模块</span><br><span class="line"></span><br><span class="line">所有的远程执行命令格式都是&quot;&lt;module&gt;.&lt;function&gt;&quot;格式,例如:</span><br><span class="line">[root@saltserver ~]# salt &apos;192.168.13.187&apos; sys.list_modules</span><br><span class="line">[root@saltserver ~]# salt &apos;192.168.13.187&apos; sys.list_functions test</span><br><span class="line">[root@saltserver ~]# salt &apos;192.168.13.187&apos; sys.doc test.sleep</span><br><span class="line"></span><br><span class="line">* 远程命令执行模块</span><br><span class="line">  [root@saltserver ~]# salt &apos;*&apos; cmd.run &apos;ps aux|wc -l&apos;  </span><br><span class="line">  192.168.13.187:</span><br><span class="line">    139</span><br><span class="line">  [root@saltserver ~]# salt &apos;*&apos; cmd.run_all &apos;ps aux|wc -l&apos;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">    ----------</span><br><span class="line">      pid:</span><br><span class="line">          26257</span><br><span class="line">      retcode:</span><br><span class="line">          0</span><br><span class="line">      stderr:</span><br><span class="line">      stdout:</span><br><span class="line">          139</span><br><span class="line"></span><br><span class="line">* 安装包管理</span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; pkg.install &quot;httpd&quot;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">    ----------</span><br><span class="line">    apr-util-ldap:</span><br><span class="line">        ----------</span><br><span class="line">        new:</span><br><span class="line">            1.3.9-3.el6_0.1</span><br><span class="line">        old:</span><br><span class="line">    httpd:</span><br><span class="line">        ----------</span><br><span class="line">        new:</span><br><span class="line">            2.2.15-60.el6.centos.4</span><br><span class="line">        old:</span><br><span class="line">    httpd-tools:</span><br><span class="line">        ----------</span><br><span class="line">        new:</span><br><span class="line">            2.2.15-60.el6.centos.4</span><br><span class="line">        old:</span><br><span class="line"></span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; pkg.version &quot;httpd&quot;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">    2.2.15-60.el6.centos.4</span><br><span class="line"></span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; pkg.remove &quot;httpd&quot;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">      ----------</span><br><span class="line">      httpd:</span><br><span class="line">          ----------</span><br><span class="line">          new:</span><br><span class="line">          old:</span><br><span class="line">              2.2.15-60.el6.centos.4</span><br><span class="line"></span><br><span class="line">* 管理服务模块</span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; service.status &quot;httpd&quot;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">      False</span><br><span class="line"></span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; service.start &quot;httpd&quot;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">      True</span><br><span class="line"></span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; service.stop &quot;httpd&quot;                      </span><br><span class="line">  192.168.13.187:</span><br><span class="line">      True</span><br><span class="line"></span><br><span class="line">* 文件管理模块</span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; file.stats &apos;/etc/yum.conf&apos;</span><br><span class="line">  192.168.13.187:</span><br><span class="line">    ----------</span><br><span class="line">    atime:</span><br><span class="line">        1501780111.82</span><br><span class="line">    ctime:</span><br><span class="line">        1499286732.05</span><br><span class="line">    gid:</span><br><span class="line">        0</span><br><span class="line">    group:</span><br><span class="line">        root</span><br><span class="line">    inode:</span><br><span class="line">        1044735</span><br><span class="line">    mode:</span><br><span class="line">        0644</span><br><span class="line">    mtime:</span><br><span class="line">        1361532394.0</span><br><span class="line">    size:</span><br><span class="line">        969</span><br><span class="line">    target:</span><br><span class="line">        /etc/yum.conf</span><br><span class="line">    type:</span><br><span class="line">        file</span><br><span class="line">    uid:</span><br><span class="line">        0</span><br><span class="line">    user:</span><br><span class="line">        root</span><br><span class="line">        .168.13.187:</span><br><span class="line">          None</span><br><span class="line"></span><br><span class="line">  [root@saltserver ~]# salt &apos;192.168.13.187&apos; file.chown /etc/yum.conf root root</span><br><span class="line">  192.168.13.187:</span><br><span class="line">      None</span><br><span class="line"></span><br><span class="line">* 用户管理模块</span><br><span class="line">  slat &apos;*&apos; user.add &lt;name&gt; &lt;uid&gt; &lt;gid&gt; &lt;groups&gt; &lt;home&gt; &lt;shell&gt;</span><br><span class="line">  slat &apos;*&apos; user.delete &lt;name&gt;</span><br><span class="line">  slat &apos;*&apos; user.info &lt;name&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/08/04/salt-install-standard/" data-id="cjavy9k65009x0coq3nczfivd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-linux-设置-包含头文件路径-和-动态库链接路径" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/03/linux-设置-包含头文件路径-和-动态库链接路径/" class="article-date">
  <time datetime="2017-08-03T06:43:38.000Z" itemprop="datePublished">2017-08-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/system-service/">system service</a>►<a class="article-category-link" href="/categories/system-service/CentOS/">CentOS</a>►<a class="article-category-link" href="/categories/system-service/CentOS/linux-设置-包含头文件路径-和-动态库链接路径/">linux 设置 包含头文件路径 和 动态库链接路径</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/03/linux-设置-包含头文件路径-和-动态库链接路径/">linux 设置 包含头文件路径 和 动态库链接路径</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="linux-设置-包含头文件路径-和-动态库链接路径"><a href="#linux-设置-包含头文件路径-和-动态库链接路径" class="headerlink" title="linux 设置 包含头文件路径 和 动态库链接路径"></a>linux 设置 包含头文件路径 和 动态库链接路径</h3><ol>
<li><p>简介</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">C/C++程序在linux下被编译和连接时,GCC/G++会查找系统默认的include和link的路径,以及自己在编译命令中指定的路径.</span><br><span class="line">而我们自己安装的第三方软件包后,如果指定了路径,我们如何加入到系统环境变量中?</span><br><span class="line"></span><br><span class="line">//include头文件路径</span><br><span class="line">除了默认的&quot;/usr/include&quot;,&quot;/usr/local/include&quot;等include路径外,还可以通过设置环境变量来添加系统include的路径:</span><br><span class="line">* C</span><br><span class="line">  export C_INCLUDE_PATH=XXXX:$C_INCLUDE_PATH</span><br><span class="line">* CPP</span><br><span class="line">  export CPLUS_INCLUDE_PATH=XXX:$CPLUS_INCLUDE_PATH</span><br><span class="line"></span><br><span class="line">//动态库链接库文件路径</span><br><span class="line">一般Linux系统把&quot;/lib&quot;,&quot;/usr/lib&quot;,&quot;/usr/local/lib&quot;作为默认的库搜索路径,所以使用这几个目录中的链接库文件可直接被搜索到.还可以通过设置环境变量来添加到搜索中</span><br><span class="line">方法一:</span><br><span class="line">* 动态链接库搜索路径:</span><br><span class="line">  export LD_LIBRARY_PATH=XXX:$LD_LIBRARY_PATH</span><br><span class="line">* 静态链接库搜索路径：</span><br><span class="line">  export LIBRARY_PATH=XXX:$LIBRARY_PATH</span><br><span class="line">方法二:</span><br><span class="line">echo &quot;/path/to/app/lib&quot; | tee /etc/ld.so.conf.d/app.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@smallasa build]<span class="comment"># pip install pygit2</span></span><br><span class="line">报错信息:</span><br><span class="line">src/types.h:36:2: error: <span class="comment">#error You need a compatible libgit2 version (v0.26.x)</span></span><br><span class="line"></span><br><span class="line">解决方法:</span><br><span class="line">[root@smallasa app]<span class="comment"># wget https://codeload.github.com/libgit2/libgit2/tar.gz/v0.26.0</span></span><br><span class="line">[root@smallasa app]<span class="comment"># tar xzf v0.26.</span></span><br><span class="line">[root@smallasa app]<span class="comment"># cd libgit2-0.26.0/</span></span><br><span class="line">[root@smallasa libgit2-0.26.0]<span class="comment"># mkdir build &amp;&amp; cd build</span></span><br><span class="line">[root@smallasa build]<span class="comment"># cmake ..</span></span><br><span class="line">[root@smallasa build]<span class="comment"># cmake --build .</span></span><br><span class="line">[root@smallasa build]<span class="comment"># make test</span></span><br><span class="line">[root@smallasa build]<span class="comment"># ./libgit2_clar</span></span><br><span class="line">[root@smallasa build]<span class="comment"># cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local/libgit2</span></span><br><span class="line">[root@smallasa build]<span class="comment"># cmake --build . --target install</span></span><br><span class="line"></span><br><span class="line">设置头文件路径 和 动态库链接路径:</span><br><span class="line">[root@smallasa build]<span class="comment"># echo 'export C_INCLUDE_PATH=/usr/local/libgit2/include:$C_INCLUDE_PATH' |tee /etc/profile.d/libgit2.sh</span></span><br><span class="line">[root@smallasa build]<span class="comment"># echo 'export CPLUS_INCLUDE_PATH=/usr/local/libgit2/include:$CPLUS_INCLUDE_PATH' |tee -a /etc/profile.d/libgit2.sh</span></span><br><span class="line">[root@smallasa build]<span class="comment"># echo 'export LD_LIBRARY_PATH=/usr/local/libgit2/lib:$LD_LIBRARY_PATH' | tee -a /etc/profile.d/libgit2.sh</span></span><br><span class="line">[root@smallasa build]<span class="comment"># echo 'export LIBRARY_PATH=/usr/local/libgit2/lib:$LIBRARY_PATH' | tee -a /etc/profile.d/libgit2.sh</span></span><br><span class="line">[root@smallasa build]<span class="comment"># source /etc/profile</span></span><br><span class="line"></span><br><span class="line">提示: 如果不指定头文件路径和动态链接库路径,会报错如下:</span><br><span class="line">src/blob.h:33:18: fatal error: git2.h: No such file or directory</span><br><span class="line"></span><br><span class="line">成功安装:</span><br><span class="line">[root@smallasa build]<span class="comment"># pip install pygit2</span></span><br><span class="line">Successfully installed pygit2-0.26.0</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/08/03/linux-设置-包含头文件路径-和-动态库链接路径/" data-id="cjavy9jzq005s0coqbm1fubp8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-vim-shortcut-key" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/02/vim-shortcut-key/" class="article-date">
  <time datetime="2017-08-02T08:45:22.000Z" itemprop="datePublished">2017-08-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/IDE/">IDE</a>►<a class="article-category-link" href="/categories/IDE/vim/">vim</a>►<a class="article-category-link" href="/categories/IDE/vim/vim-shortcut-key/">vim shortcut key</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/02/vim-shortcut-key/">vim shortcut key</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="vim-快捷键"><a href="#vim-快捷键" class="headerlink" title="vim 快捷键"></a>vim 快捷键</h3><ol>
<li><p>删除行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dd    删除(剪切)光标当前1行</span><br><span class="line">&#123;n&#125;dd 删除(剪切)光标之下n行</span><br><span class="line"></span><br><span class="line">dgg   剪切光标以上的所有行</span><br><span class="line">dG    剪切光标以下的所有行</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除词</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x   删除光标所在处字符</span><br><span class="line">X   删除光标所在前字符</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/08/02/vim-shortcut-key/" data-id="cjavy9k7d00az0coqrqbc8732" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-salt-info" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/01/salt-info/" class="article-date">
  <time datetime="2017-08-01T03:01:39.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/automation/">automation</a>►<a class="article-category-link" href="/categories/automation/salt/">salt</a>►<a class="article-category-link" href="/categories/automation/salt/salt-info/">salt info</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/01/salt-info/">salt info</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="salt-介绍"><a href="#salt-介绍" class="headerlink" title="salt 介绍"></a>salt 介绍</h3><ol>
<li><p>saltstack是什么?<br><strong>SaltStack是基于Python开发的一套C/S架构配置管理工具,它的底层使用ZeroMQ消息队列pub/sub方式通信,使用SSL证书签发的方式进行认证管理.</strong></p>
</li>
<li><p>saltstack服务架构<br><strong>SaltStack是一种基于C/S架构的服务模式,可以简单地理解为如果我们想使用SaltStack就需要在现有的环境下引入与护一套C/S架构.<br>在SaltStack架构中服务器端叫作Master,客户端叫作Minion.<br>在我们理解的传统C/S架构中,客户端发送请求给服务器端,服务器端接收到请求并且处理完成后再返回给客户端.<br>在SaltStack架构中不仅有传统的C/S架构服务模式,而且有消息队列中的发布与订阅(pub/sub)服务模式.<br>这使得SaltStack应用场景更加丰富.目前在实际环境中一般使用SaltStack的C/S架构进行配置管理</strong></p>
</li>
<li><p>saltstack设计理念<br><strong>saltstack 两个主要设计理念是: 远程执行 和 配置管理</strong></p>
</li>
<li><p>saltstack架构模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">模式一: Master -&gt; Minion</span><br><span class="line">master和所有的minion都直接连接,minion接收来自master的指令,完成命令执行或配置管理</span><br><span class="line"></span><br><span class="line">模式二: Master -&gt; Syndic -&gt; Minion</span><br><span class="line">master通过syndic对minion进行管理,同时该架构可进行多级扩展</span><br><span class="line"></span><br><span class="line">模式三: Minion(无master)</span><br><span class="line">无master的minion,minion不接受任何master控制,通过本地运行即可完成相关功能</span><br><span class="line"></span><br><span class="line">模式四: Master -&gt; Master -&gt; Minion</span><br><span class="line">多Master架构,所有的Minion将连接到所有配置的Master上去</span><br><span class="line"></span><br><span class="line">模式五: salt-ssh</span><br><span class="line">通过SSH通道直接在远程主机上执行使用SaltStack,而不需要在远程主机上运行Salt Minion,同时又能支持SaltStack的大部分功能,而且Salt Master也不需要运行了</span><br><span class="line"></span><br><span class="line">模式六: salt-cloud</span><br><span class="line"></span><br><span class="line">模式七: salt-proxy</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/08/01/salt-info/" data-id="cjavy9k5x009s0coqrp569axh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-RabbitMQ-python-pika" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/28/RabbitMQ-python-pika/" class="article-date">
  <time datetime="2017-07-28T02:58:20.000Z" itemprop="datePublished">2017-07-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hadoop/">hadoop</a>►<a class="article-category-link" href="/categories/hadoop/RabbitMQ/">RabbitMQ</a>►<a class="article-category-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-python-pika/">RabbitMQ python pika</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/28/RabbitMQ-python-pika/">RabbitMQ python pika</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="RabbitMQ-python-pika"><a href="#RabbitMQ-python-pika" class="headerlink" title="RabbitMQ python pika"></a>RabbitMQ python pika</h3><ol>
<li><p>RabbitMQ 安装和用户权限设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* RabbitMQ 安装,此步骤忽略</span><br><span class="line"></span><br><span class="line">* 创建vhost</span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl add_vhost /<span class="built_in">test</span></span><br><span class="line">  Creating vhost <span class="string">"/test"</span></span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_vhosts|grep <span class="built_in">test</span></span><br><span class="line">  /<span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">* 对创建的vhost设置高可用</span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl set_policy -p /<span class="built_in">test</span> ha-all <span class="string">"^"</span> <span class="string">'&#123;"ha-mode":"all"&#125;'</span></span><br><span class="line">  Setting policy <span class="string">"ha-all"</span> <span class="keyword">for</span> pattern <span class="string">"^"</span> to <span class="string">"&#123;\"ha-mode\":\"all\"&#125;"</span> with priority <span class="string">"0"</span></span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_policies -p /<span class="built_in">test</span>               Listing policies</span><br><span class="line">  /<span class="built_in">test</span>   ha-all  all     ^       &#123;<span class="string">"ha-mode"</span>:<span class="string">"all"</span>&#125;       0</span><br><span class="line"></span><br><span class="line">* 创建用户</span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl add_user <span class="built_in">test</span> test123</span><br><span class="line">  Creating user <span class="string">"test"</span></span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_users|grep <span class="built_in">test</span></span><br><span class="line">  <span class="built_in">test</span>    []</span><br><span class="line"></span><br><span class="line">* 为用户设置角色</span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl set_user_tags <span class="built_in">test</span> administrator monitoring  </span><br><span class="line">  Setting tags <span class="keyword">for</span> user <span class="string">"test"</span> to [administrator,monitoring]</span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_users|grep <span class="built_in">test</span>                 <span class="built_in">test</span>    [administrator, monitoring]</span><br><span class="line"></span><br><span class="line">* 为用户设置权限</span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl set_permissions -p /<span class="built_in">test</span> <span class="built_in">test</span> <span class="string">'.*'</span> <span class="string">'.*'</span> <span class="string">'.*'</span>      </span><br><span class="line">  Setting permissions <span class="keyword">for</span> user <span class="string">"test"</span> <span class="keyword">in</span> vhost <span class="string">"/test"</span></span><br><span class="line">  [wisdom@rabbitmq188 ~]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_permissions -p /<span class="built_in">test</span>            Listing permissions <span class="keyword">in</span> vhost <span class="string">"/test"</span></span><br><span class="line">  <span class="built_in">test</span>    .*      .*      .*</span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="http://pika.readthedocs.io/en/latest/_modules/pika/connection.html#ConnectionParameters" target="_blank" rel="noopener">Python pika install</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rabbitmq188 ~]<span class="comment"># pip install pika</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>RabbitMQ 单向发送消息<br><img src="RabbitMQ-python-pika/RabbitMQ.单向发送消息.jpg" alt="RabbitMQ 单向发送消息"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_queues -p /<span class="built_in">test</span></span><br><span class="line">Listing queues</span><br><span class="line"></span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布消息</span></span><br><span class="line">channel.basic_publish(exchange=<span class="string">""</span>,</span><br><span class="line">                    routing_key=<span class="string">"queue_hello"</span>,</span><br><span class="line">                    body=<span class="string">'Hello World!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"msg_send 'Hello World!'"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py</span><br><span class="line">msg_send <span class="string">'Hello World!'</span></span><br><span class="line">[wisdom@rabbitmq188 web]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_queues -p /<span class="built_in">test</span> |grep hello</span><br><span class="line">queue_hello     1</span><br><span class="line">[wisdom@rabbitmq188 web]$ /mnt/app/rabbitmq/sbin/rabbitmqctl list_exchanges -p /<span class="built_in">test</span> |grep hello</span><br><span class="line">exchange_hello  direct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_receive.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % body)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_hello'</span>,</span><br><span class="line">                      no_ack=True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_receive.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//执行msg_send.py 脚本,然后观察 msg_receive.py</span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_receive.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[x] Received <span class="string">'Hello World!'</span></span><br><span class="line">[x] Received <span class="string">'Hello World!'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>RabbitMQ 工作队列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">消息也可以理解为任务,消息发送者可以理解为任务分配者,消息接收者可以理解为工作者,当工作者接收到一个任务,还没完成的时候,任务分配者又发一个任务过来,那就忙不过来了,于是就需要多个工作者来共同处理这些任务,这些工作者,就称为工作队列</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-python-pika/RabbitMQ.工作队列.jpg" alt="RabbitMQ 工作队列"><br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line">message = <span class="string">' '</span>.join(sys.argv[1:]) or <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布消息</span></span><br><span class="line">channel.basic_publish(exchange=<span class="string">""</span>,</span><br><span class="line">                    routing_key=<span class="string">"queue_hello"</span>,</span><br><span class="line">                    body=message)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"[x] Sent %r"</span> % (message,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者(worker_1.py和worker_2 内容一致)</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; worker_1.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line">    time.sleep(body.count(<span class="string">'.'</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Done"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_hello'</span>,</span><br><span class="line">                      no_ack=True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//启动worker_1.py和worker_2.py</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_1.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_2.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line"></span><br><span class="line">//执行 msg_send.py向队列写入数据</span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py First message.</span><br><span class="line">[x] Sent <span class="string">'First message.'</span></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py Second message.</span><br><span class="line">[x] Sent <span class="string">'Second message.'</span></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py Third message.</span><br><span class="line">[x] Sent <span class="string">'Third message.'</span></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py Fourth message.</span><br><span class="line">[x] Sent <span class="string">'Fourth message.'</span></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py Fifth message.</span><br><span class="line">[x] Sent <span class="string">'Fifth message.'</span></span><br><span class="line"></span><br><span class="line">//worker_1.py返回状态</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_1.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[x] Received <span class="string">'Second message.'</span></span><br><span class="line">[x] Done</span><br><span class="line">[x] Received <span class="string">'Fourth message.'</span></span><br><span class="line">[x] Done</span><br><span class="line"></span><br><span class="line">//worker_2.py返回状态</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_2.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[x] Received <span class="string">'First message.'</span></span><br><span class="line">[x] Done</span><br><span class="line">[x] Received <span class="string">'Third message.'</span></span><br><span class="line">[x] Done</span><br><span class="line">[x] Received <span class="string">'Fifth message.'</span></span><br><span class="line">[x] Done</span><br><span class="line"></span><br><span class="line">综上,每个工作者,都会依次分配到任务.如果一个工作者,在处理任务的时候挂掉,这个任务就没有完成,应当交由其他工作者处理.所以应当有一种机制,当一个工作者完成任务时,会反馈消息.</span><br></pre></td></tr></table></figure></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">消息确认就是当工作者完成任务后,会反馈给rabbitmq.修改worker.py中的回调函数:</span><br><span class="line"></span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; worker_1.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line">    time.sleep(5)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Done"</span>)</span><br><span class="line">    ch.basic_ack(delivery_tag = method.delivery_tag)   <span class="comment">#消息确认</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_hello'</span>,</span><br><span class="line">                      no_ack=False)   <span class="comment"># no_ack 关闭</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//启动work_1.py和worker_2.py</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_1.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_2.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line"></span><br><span class="line">//执行 msg_send.py向队列写入数据</span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_send.py First message.  </span><br><span class="line">[x] Sent <span class="string">'First message.'</span></span><br><span class="line"></span><br><span class="line">//执行向队列发送消息后,我发现woker_1.py收到消息,我立即中断woker_1.py程序</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_1.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[x] Received <span class="string">'First message.'</span></span><br><span class="line">^CTraceback (most recent call last):   <span class="string">"Ctrl+C 退出"</span></span><br><span class="line"></span><br><span class="line">//在5秒中内停止worker_1.py后,worker_2.py接收消息并继续处理</span><br><span class="line">[wisdom@rabbitmq188 web]$ python worker_2.py</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br><span class="line">[x] Received <span class="string">'First message.'</span></span><br><span class="line">[x] Done</span><br><span class="line"></span><br><span class="line">综上,通过消息确认,即使其中一个工作者ctrl+c退出后,正在执行的任务也不会丢失,rabbitmq会将任务重新分配给其他工作者</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">虽然有了消息反馈机制,正在执行的任务不会丢失,但是如果rabbitmq本身服务挂掉的话,那么任务还是会丢失.所以需要将任务持久化存储起来.声明持久化存储:</span><br><span class="line"></span><br><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line">message = <span class="string">' '</span>.join(sys.argv[1:]) or <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>,durable=True)  <span class="comment">#创建队列,声明持久化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布消息</span></span><br><span class="line">channel.basic_publish(exchange=<span class="string">""</span>,</span><br><span class="line">                    routing_key=<span class="string">"queue_hello"</span>,</span><br><span class="line">                    body=message,</span><br><span class="line">                    properties=pika.BasicProperties(</span><br><span class="line">                        delivery_mode = 2,    <span class="comment"># 持久化参数</span></span><br><span class="line">                    ))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"[x] Sent %r"</span> % (message,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; worker_1.py &lt;&lt;EOF    </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>,durable=True)  <span class="comment"># 声明持久化队列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line">    time.sleep(5)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Done"</span>)</span><br><span class="line">    ch.basic_ack(delivery_tag = method.delivery_tag)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_hello'</span>,</span><br><span class="line">                      no_ack=False)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">声明队列的时候,需要添加<span class="string">"durable=True"</span>参数,如果队列已经存在,程序执行会报错.rabbitmq不允许使用不同的参数来重新定义存在的队列,所以需要定义一个新的队列.</span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>,durable=True)</span><br></pre></td></tr></table></figure>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">公平调度:</span><br><span class="line">上面实例中,虽然每个工作者是依次分配到任务,但是每个任务不一定一样.可能有的任务比较重,执行时间比较久;有的任务比较轻,执行时间比较短.如果能公平调度就最好了,使用basic_qos设置prefetch_count=1,使得rabbitmq不会在同一时间给工作者分配多个任务,即只有工作者完成任务之后,才会再次接收到任务.</span><br><span class="line"></span><br><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF     </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line">message = <span class="string">' '</span>.join(sys.argv[1:]) or <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>,durable=True)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布消息</span></span><br><span class="line">channel.basic_publish(exchange=<span class="string">""</span>,</span><br><span class="line">                    routing_key=<span class="string">"queue_hello"</span>,</span><br><span class="line">                    body=message,</span><br><span class="line">                    properties=pika.BasicProperties(</span><br><span class="line">                        delivery_mode = 2,</span><br><span class="line">                    ))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"[x] Sent %r"</span> % (message,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; worker_1.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列(消息发送到队列)</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_hello'</span>,durable=True)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line">    time.sleep(5)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Done"</span>)</span><br><span class="line">    ch.basic_ack(delivery_tag = method.delivery_tag)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 公平调度</span></span><br><span class="line">channel.basic_qos(prefetch_count=1)  <span class="comment"># 公平调度</span></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_hello'</span>,</span><br><span class="line">                      no_ack=False)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">注意,公平调度主要是在消费者上进行设置:</span><br><span class="line">channel.basic_qos(prefetch_count=1)</span><br></pre></td></tr></table></figure>
<ol>
<li>RabbitMQ 交换器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">工作队列,每次消息都只会发送给其中一个接收端,如果需要将消息广播出去,让每个接收端都能收到,那么就要使用交换机</span><br><span class="line"></span><br><span class="line">交换机的工作原理: 消息发送端先将消息发送给交换机,交换机再将消息发送到绑定的消息队列,而后每个接收端都能从各自的消息队列里接收到信息</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-python-pika/RabbitMQ.交换机.jpg" alt="RabbitMQ 工作队列"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line">message = <span class="string">' '</span>.join(sys.argv[1:]) or <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建交换机</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">"exchange_hello"</span>,<span class="built_in">type</span>=<span class="string">'fanout'</span>)   <span class="comment">#创建交换机</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布消息</span></span><br><span class="line">channel.basic_publish(exchange=<span class="string">"exchange_hello"</span>,   <span class="comment">#发布消息到交换机</span></span><br><span class="line">                    routing_key=<span class="string">""</span>,</span><br><span class="line">                    body=<span class="string">'Hello World!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"[x] Sent 'Hello World!'"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">1.生产者要将消息发送到交换机,而不是队列.</span><br><span class="line">2.basic_publish方法的参数exchange被设定为相应交换机,因为是要广播出去,发送到所有队列,所以routing_key就不需要设定了</span><br><span class="line">3.exchange如果为空,表示是使用匿名的交换机(例如:amq.*这样的交换机,就是系统默认的交换机).routing_key在使用匿名交换机的时候才需要指定,表示发送到哪个队列的意思</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_receive.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建交换机</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">'exchange_hello'</span>, <span class="built_in">type</span>=<span class="string">'fanout'</span>)  <span class="comment"># 创建交换机</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建随机队列,并绑定到交换机上</span></span><br><span class="line"><span class="comment"># "exclusive=True"表示当接收端退出时,销毁临时产生的队列</span></span><br><span class="line">queue_random = channel.queue_declare(exclusive=True)                <span class="comment"># 创建随机队列,并绑定到交换机.</span></span><br><span class="line">queue_name = queue_random.method.queue</span><br><span class="line">channel.queue_bind(exchange=<span class="string">'exchange_hello'</span>,queue=queue_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=queue_name,</span><br><span class="line">                      no_ack=True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>RabbitMQ 路由键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">交换机已经能实现给所有接收端发送消息,但是如果需要自由定制,有的消息发给其中一些接收端,有些消息发送给另外一些接收端,这种情况就需要用到路由键了</span><br><span class="line"></span><br><span class="line">路由键的工作原理: 每个接收端的消息队列在绑定交换机的时候,可以设定相应的路由键.发送端通过交换机发送信息时,可以指明路由键,交换机会根据路由键把消息发送到相应的消息队列,这样接收端就能接收到消息了</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建交换机</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">"exchange_hello"</span>,<span class="built_in">type</span>=<span class="string">'direct'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义三个路由键</span></span><br><span class="line">routings = [<span class="string">'info'</span>,<span class="string">'warning'</span>,<span class="string">'error'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将消息发布到交换机,并设置路由键</span></span><br><span class="line"><span class="keyword">for</span> routing <span class="keyword">in</span> routings:</span><br><span class="line">    message = <span class="string">'%s message.'</span> % routing</span><br><span class="line">    channel.basic_publish(exchange=<span class="string">"exchange_hello"</span>,</span><br><span class="line">                        routing_key=routing,</span><br><span class="line">                        body=message)</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_receive.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建交换机</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">'exchange_hello'</span>, <span class="built_in">type</span>=<span class="string">'direct'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从命令行获取路由键参数,如果没有,默认为info</span></span><br><span class="line">routings = sys.argv[1:]</span><br><span class="line"><span class="keyword">if</span> not routings:</span><br><span class="line">    routings = [<span class="string">'info'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建随机队列,并绑定到交换机上,设置路由键</span></span><br><span class="line">queue_random = channel.queue_declare(exclusive=True)</span><br><span class="line">queue_name = queue_random.method.queue</span><br><span class="line"><span class="keyword">for</span> routing <span class="keyword">in</span> routings:</span><br><span class="line">    channel.queue_bind(exchange=<span class="string">'exchange_hello'</span>,</span><br><span class="line">                    queue=queue_name,</span><br><span class="line">                    routing_key=routing)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=queue_name,</span><br><span class="line">                      no_ack=True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//执行msg_receive.py</span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_receive.py warning error</span><br><span class="line">[*] Waiting <span class="keyword">for</span> messages. To <span class="built_in">exit</span> press CTRL+C</span><br></pre></td></tr></table></figure>
</li>
<li><p>RabbitMQ 路由键模糊匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通过设置路由键,可以将消息发送到相应的队列,这里的路由键是要完全匹配,比如: info消息的只能发到路由键为info的消息队列</span><br><span class="line">路由键模糊匹配,就是可以使用正则表达式.和常用的正则表示式不同,这里的话&quot;#&quot;表示所有,全部的意思;&quot;*&quot;只匹配到一个词</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line">message = <span class="string">' '</span>.join(sys.argv[1:]) or <span class="string">"Hello World!"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建交换机</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">"exchange_hello"</span>,<span class="built_in">type</span>=<span class="string">'topic'</span>)  <span class="comment"># 设置为topic类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义三个路由键</span></span><br><span class="line">routings = [<span class="string">'happy.work'</span>,<span class="string">'happy.life'</span>,<span class="string">'sad.work'</span>,<span class="string">'sad.life'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将消息发布到交换机,并设置路由键</span></span><br><span class="line"><span class="keyword">for</span> routing <span class="keyword">in</span> routings:</span><br><span class="line">    message = <span class="string">'%s message.'</span> % routing</span><br><span class="line">    channel.basic_publish(exchange=<span class="string">"exchange_hello"</span>,</span><br><span class="line">                        routing_key=routing,</span><br><span class="line">                        body=message)</span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭与RabbitMQ建立连接</span></span><br><span class="line">conn_broker.close()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_receive.py &lt;&lt;EOF     </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建交换机</span></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">'exchange_hello'</span>, <span class="built_in">type</span>=<span class="string">'topic'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从命令行获取路由键参数,如果没有,则报错退出</span></span><br><span class="line">routings = sys.argv[1:]</span><br><span class="line"><span class="keyword">if</span> not routings:</span><br><span class="line">    <span class="built_in">print</span> &gt;&gt; sys.stderr,<span class="string">"Usage: %s [routing_key]..."</span> % (sys.argv[0])</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建随机队列,并绑定到交换机上,设置路由键</span></span><br><span class="line">queue_random = channel.queue_declare(exclusive=True)</span><br><span class="line">queue_name = queue_random.method.queue</span><br><span class="line"><span class="keyword">for</span> routing <span class="keyword">in</span> routings:</span><br><span class="line">    channel.queue_bind(exchange=<span class="string">'exchange_hello'</span>,</span><br><span class="line">                    queue=queue_name,</span><br><span class="line">                    routing_key=routing)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[x] Received %r"</span> % (body,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=queue_name,</span><br><span class="line">                      no_ack=True)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//运行接收端</span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_receive.py <span class="string">"*.work"</span></span><br><span class="line">[wisdom@rabbitmq188 web]$ python msg_receive.py <span class="string">"happy.*"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">补充说明:</span><br><span class="line">1.发送信息时,如果不设置路由键,那么路由键设置为<span class="string">"*"</span>的接收端是否能接收到消息?</span><br><span class="line">发送信息时,如果不设置路由键,默认是表示广播出去,理论上所有接收端都可以收到消息,但经测试,路由键设置为<span class="string">"*"</span>的接收端收不到任何消息.只有发送消息时,设置路由键为一个词,路由键设置为<span class="string">"*"</span>的接收端才能收到消息.在这里,每个词使用<span class="string">"."</span>符号分开的</span><br><span class="line"></span><br><span class="line">2.发送消息时,如果路由键设置为<span class="string">".."</span>,那么路由键设置为<span class="string">"#."</span>的接收端是否能接收到消息?如果发送消息时,路由键设置为一个词呢?</span><br><span class="line">两种情况,测试都可以</span><br><span class="line"></span><br><span class="line">3.<span class="string">"a.*.#"</span> 和<span class="string">"a.#"</span>的区别</span><br><span class="line"><span class="string">"a.#"</span>只要字符串开头的一个词是a就可以了,比如a,a.haha,a.haha.haha;而这样的词是不行的,如abs,abc,abc.haha</span><br><span class="line"><span class="string">"a.*.#"</span>必须要满足a.*的字符串才可以,比如a.,a.haha,a.haha.haha.而这样的词是不行的,如a</span><br></pre></td></tr></table></figure>
<ol>
<li><p>RabbitMQ 远程结果返回</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">前面的例子都有个共同点,就是发送端发送消息出去后没有结果返回.如果只是单纯发送消息,当然没有问题了.但是在实际中,常常会需要接收端将收到的消息进行处理之后,返回给发送端.</span><br><span class="line"></span><br><span class="line">处理方法描述: 发送端在发送信息前,产生一个接收消息的临时队列,该队列用来接收返回的结果.其实在这里接收端,发送端的概念已经比较模糊了,因为发送端也同样要接收消息,接收端同样也要发送消息</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">示例内容: 假设有一个控制中心和一个计算节点,控制中心会将一个自然数N发送给计算节点,计算节点将N值加1后,返回给控制中心.这里用center.py模拟控制中心,compute.py模拟计算节点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF     </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Center(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        <span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">        self.credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line">        self.conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                                    5672,</span><br><span class="line">                                                    <span class="string">"/test"</span>,</span><br><span class="line">                                                    credentials = self.credentials)</span><br><span class="line">        self.conn_broker = pika.BlockingConnection(self.conn_params)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">        self.channel = self.conn_broker.channel()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义接收到返回消息处理方法</span></span><br><span class="line">    def on_response(self,ch,method,props,body):</span><br><span class="line">        self.response = body</span><br><span class="line"></span><br><span class="line">    def request(self,n):</span><br><span class="line">        self.response = None</span><br><span class="line">        <span class="comment">#发送计算请求,并声明返回队列</span></span><br><span class="line">        self.channel.basic_publish(exchange=<span class="string">''</span>,</span><br><span class="line">                                routing_key=<span class="string">'queue_compute'</span>,</span><br><span class="line">                                properties=pika.BasicProperties(</span><br><span class="line">                                    reply_to = self.callback_queue,</span><br><span class="line">                                ),</span><br><span class="line">                                body=str(n))    </span><br><span class="line">        <span class="comment">#接收返回的数据</span></span><br><span class="line">        <span class="keyword">while</span> self.response is None:</span><br><span class="line">            self.conn_broker.process_data_events()</span><br><span class="line">        <span class="built_in">return</span> int(self.response)</span><br><span class="line"></span><br><span class="line">center = Center()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">" [x] Requesting increase(30)"</span></span><br><span class="line">response = center.request(30)</span><br><span class="line"><span class="built_in">print</span> <span class="string">" [.] Got %r"</span> % (response,)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_receive.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_compute'</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将n值加1</span></span><br><span class="line">def increase(n):</span><br><span class="line">    <span class="built_in">return</span> n + 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[.] increase(%s)"</span> % (body,))</span><br><span class="line">    response = increase(int(body))</span><br><span class="line">    <span class="comment"># 将计算结果返回生产者</span></span><br><span class="line">    ch.basic_publish(exchange=<span class="string">''</span>,</span><br><span class="line">                    routing_key=properties.reply_to,</span><br><span class="line">                    body=str(response))</span><br><span class="line">    ch.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line"></span><br><span class="line">channel.basic_qos(prefetch_count=1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_compute'</span>,</span><br><span class="line">                      no_ack=False)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>RabbitMQ 相互关联编号”correlation id”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">远程结果中有一个没有提到,就是&quot;correlation id&quot;,这是什么呢?</span><br><span class="line"></span><br><span class="line">假设有多个计算节点,控制中心开启多个线程,往这些计算节点发送数字,要求计算结果并返回,但是控制中心只开启了一个队列,所有线程都是从这个队列里获取消息,每个线程如何确定收到的消息就是该线程对应的呢?这个就是&quot;correlation id&quot;的用处了.correlation翻译成中文就是相互关联,也表达了这个意思</span><br><span class="line"></span><br><span class="line">&quot;correlation id&quot;运行原理: 控制中心发送计算请求时设置&quot;correlation id&quot;,而后计算节点将计算结果,连同接收到的&quot;correlation id&quot;一起返回,这样控制中心就能通过&quot;correlation id&quot;来标识请求.其实&quot;correlation id&quot;也可以理解为请求的唯一标识码</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">示例内容: 控制中心开启多个线程,每个线程都发起一次计算请求,通过<span class="string">"correlation id"</span>,每个线程都能准确收到相应的计算结果</span><br><span class="line"></span><br><span class="line">//生产者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_send.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import threading</span><br><span class="line">import uuid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义线程类,继承threading.Thread</span></span><br><span class="line">class MyThread(threading.Thread):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        super(MyThread,self).__init()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.num = num</span><br><span class="line">    def run(self):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[x] Requesting increase(%d)"</span> % self.num)</span><br><span class="line">        response = self.func(self.num)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"[.] increase(%d)=%d"</span> % (self.num, response)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制中心类</span></span><br><span class="line">class Center(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        <span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">        self.credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line">        self.conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                                    5672,</span><br><span class="line">                                                    <span class="string">"/test"</span>,</span><br><span class="line">                                                    credentials = self.credentials)</span><br><span class="line">        self.conn_broker = pika.BlockingConnection(self.conn_params)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">        self.channel = self.conn_broker.channel()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义接收返回消息队列</span></span><br><span class="line">        result = self.channel.queue_declare(exclusive=True)</span><br><span class="line">        self.callback_queue = result.method.queue</span><br><span class="line">        self.channel.basic_consume(self.on_response,</span><br><span class="line">                                   no_ack=True,</span><br><span class="line">                                   queue=self.callback_queue)</span><br><span class="line">        <span class="comment">#返回的结果都会存储在该字典里</span></span><br><span class="line">        self.response = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义接收到返回消息处理方法</span></span><br><span class="line">    def on_response(self,ch,method,props,body):</span><br><span class="line">        self.response[props.correlation_id] = body</span><br><span class="line"></span><br><span class="line">    def request(self,n):</span><br><span class="line">        corr_id = str(uuid.uuid4())</span><br><span class="line">        self.response[corr_id] = None</span><br><span class="line">        <span class="comment">#发送计算请求,并声明返回队列</span></span><br><span class="line">        self.channel.basic_publish(exchange=<span class="string">''</span>,</span><br><span class="line">                                routing_key=<span class="string">'queue_compute'</span>,</span><br><span class="line">                                properties=pika.BasicProperties(</span><br><span class="line">                                    reply_to = self.callback_queue,</span><br><span class="line">                                    correlation_id = corr_id,</span><br><span class="line">                                ),</span><br><span class="line">                                body=str(n))    </span><br><span class="line">        <span class="comment">#接收返回的数据</span></span><br><span class="line">        <span class="keyword">while</span> self.response is None:</span><br><span class="line">            self.conn_broker.process_data_events()</span><br><span class="line">        <span class="built_in">return</span> int(self.response[corr_id])</span><br><span class="line"></span><br><span class="line">center = Center()</span><br><span class="line"><span class="comment">#发起5次计算请求</span></span><br><span class="line">nums= [10, 20, 30, 40 ,50]</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">    threads.append(MyThread(center.request, num))</span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.start()</span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">//消费者</span><br><span class="line">[wisdom@rabbitmq188 web]$ cat &gt; msg_receive.py &lt;&lt;EOF</span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import pika</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立与RabbitMQ建立连接</span></span><br><span class="line">credentials = pika.PlainCredentials(<span class="string">"test"</span>,<span class="string">"test123"</span>)</span><br><span class="line"></span><br><span class="line">conn_params = pika.ConnectionParameters(<span class="string">"192.168.13.188"</span>,</span><br><span class="line">                                        5672,</span><br><span class="line">                                        <span class="string">"/test"</span>,</span><br><span class="line">                                        credentials = credentials)</span><br><span class="line"></span><br><span class="line">conn_broker = pika.BlockingConnection(conn_params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建信道(生产者和消费者与RabbitMQ建立一条通道)</span></span><br><span class="line">channel = conn_broker.channel()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列</span></span><br><span class="line">channel.queue_declare(queue=<span class="string">'queue_compute'</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将n值加1</span></span><br><span class="line">def increase(n):</span><br><span class="line">    <span class="built_in">return</span> n + 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建消费消息</span></span><br><span class="line">def callback(ch, method, properties, body):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[.] increase(%s)"</span> % (body,))</span><br><span class="line">    response = increase(int(body))</span><br><span class="line">    <span class="comment"># 将计算结果返回生产者,增加"correlation_id"的设定</span></span><br><span class="line">    ch.basic_publish(exchange=<span class="string">''</span>,</span><br><span class="line">                    routing_key=properties.reply_to,</span><br><span class="line">                    properties=pika.BasicProperties(correlation_id= \</span><br><span class="line">                                                    props.correlation_id),</span><br><span class="line">                    body=str(response))</span><br><span class="line">    ch.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line"></span><br><span class="line">channel.basic_qos(prefetch_count=1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅消息</span></span><br><span class="line">channel.basic_consume(callback,</span><br><span class="line">                      queue=<span class="string">'queue_compute'</span>,</span><br><span class="line">                      no_ack=False)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'[*] Waiting for messages. To exit press CTRL+C'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始消费</span></span><br><span class="line">channel.start_consuming()</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/07/28/RabbitMQ-python-pika/" data-id="cjavy9jtr000p0coqnsw6hnv7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-command-tr" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/26/command-tr/" class="article-date">
  <time datetime="2017-07-26T01:18:18.000Z" itemprop="datePublished">2017-07-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/system-service/">system service</a>►<a class="article-category-link" href="/categories/system-service/command/">command</a>►<a class="article-category-link" href="/categories/system-service/command/tr/">tr</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/26/command-tr/">command tr</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>tr 将多个空格替换为1个空格</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@dev ~]<span class="comment"># cat b</span></span><br><span class="line">a   b c</span><br><span class="line">1 2   3  5</span><br><span class="line">[root@dev ~]<span class="comment"># cat b|tr -s ' '</span></span><br><span class="line">a b c</span><br><span class="line">1 2 3 5</span><br></pre></td></tr></table></figure>
</li>
<li><p>tr替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@dev ~]<span class="comment"># cat b|tr -s ' '</span></span><br><span class="line">a b c</span><br><span class="line">1 2 3 5</span><br><span class="line">[root@dev ~]<span class="comment"># cat b|tr -s ' '|tr ' ' ','</span></span><br><span class="line">a,b,c</span><br><span class="line">1,2,3,5</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/07/26/command-tr/" data-id="cjavy9juq001i0coq7elgkkpq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-树莓派-GSM-语音和短信报警" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/24/树莓派-GSM-语音和短信报警/" class="article-date">
  <time datetime="2017-07-24T02:23:44.000Z" itemprop="datePublished">2017-07-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Monitor/">Monitor</a>►<a class="article-category-link" href="/categories/Monitor/树莓派/">树莓派</a>►<a class="article-category-link" href="/categories/Monitor/树莓派/树莓派-GSM-语音短信报警/">树莓派 GSM 语音短信报警</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/24/树莓派-GSM-语音和短信报警/">树莓派 GSM 语音和短信报警</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="树莓派-GSM-语音短信报警"><a href="#树莓派-GSM-语音短信报警" class="headerlink" title="树莓派 GSM 语音短信报警"></a>树莓派 GSM 语音短信报警</h3><ol>
<li><p>树莓派系统安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 购买树莓派</span><br><span class="line">2. 购买无线网卡,读卡器,内存卡,HDMI转VGA线,USB转RS232串口连接转换线,相应的电源线</span><br><span class="line">3. 下载树莓派系统</span><br><span class="line">4. 将系统安装到内存卡中</span><br><span class="line">5. 接通电源,启动服务</span><br><span class="line">6. 通过无线网卡,连接WIFI</span><br><span class="line">7. 启动ssh服务</span><br><span class="line">root@raspberrypi:~# /etc/init.d/ssh start</span><br><span class="line">root@raspberrypi:~# update-rc.d ssh defaults</span><br><span class="line">root@raspberrypi:~# update-rc.d -f ssh remove</span><br></pre></td></tr></table></figure>
</li>
<li><p>树莓派基本操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ sudo su -</span><br><span class="line">root@raspberrypi:~<span class="comment"># apt-get update</span></span><br><span class="line">root@raspberrypi:~<span class="comment"># apt-get upgrade</span></span><br><span class="line">root@raspberrypi:~<span class="comment"># apt-get install vim ntpdate</span></span><br><span class="line">root@raspberrypi:~<span class="comment"># cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line">root@raspberrypi:~<span class="comment"># raspi-config 初始化一些配置</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="http://pan.baidu.com/s/1c2u5MY8" target="_blank" rel="noopener">树莓派工具</a> 密码:yb3k</p>
</li>
</ol>
<hr>
<h3 id="树莓派-调用-GSM模块-发送短信-和-语音"><a href="#树莓派-调用-GSM模块-发送短信-和-语音" class="headerlink" title="树莓派 调用 GSM模块 发送短信 和 语音"></a>树莓派 调用 GSM模块 发送短信 和 语音</h3><ol>
<li><p>给单个用户发送短信</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~/gsm $ cat send_sms.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> RPi.GPIO <span class="keyword">as</span> GPIO</span><br><span class="line"><span class="keyword">import</span> serial</span><br><span class="line"><span class="keyword">import</span> time, sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">P_BUTTON = <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">()</span>:</span></span><br><span class="line">    GPIO.setmode(GPIO.BOARD)</span><br><span class="line">    GPIO.setup(P_BUTTON, GPIO.IN, GPIO.PUD_UP)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Unicode2HexStr</span><span class="params">(Unicde_Str)</span>:</span></span><br><span class="line">    Hex_Str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(Unicde_Str)):</span><br><span class="line">        Hex_Str += (hex(ord(Unicde_Str[i])).replace(<span class="string">'0x'</span>,<span class="string">''</span>).zfill(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">return</span> Hex_Str</span><br><span class="line"></span><br><span class="line">INFO = Unicode2HexStr(<span class="string">'hi,刘朋'</span>)</span><br><span class="line"></span><br><span class="line">AA = binascii.a2b_hex(<span class="string">'1A'</span>)</span><br><span class="line"></span><br><span class="line">SERIAL_PORT = <span class="string">"/dev/ttyUSB0"</span></span><br><span class="line"></span><br><span class="line">ser = serial.Serial(SERIAL_PORT, baudrate = <span class="number">9600</span>, timeout = <span class="number">5</span>)</span><br><span class="line">setup()</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">'AT+CMGDA="DEL ALL"\r'</span>.encode())</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">"AT+CMGF=1\r"</span>.encode())</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">'AT+CSMP=17,167,2,25\r'</span>.encode())</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">'AT+CSCS="UCS2"\r'</span>.encode())</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">'AT+CMGS="00310035003200300031003600380034003200320033"\r'</span>.encode())</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line">ser.write(INFO.encode())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">ser.write(AA)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ser.close()</span><br></pre></td></tr></table></figure>
</li>
<li><p>给单个用户打电话,语音报警</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~/gsm $ cat send_gms.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> serial</span><br><span class="line"><span class="keyword">import</span> time, sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Unicode2HexStr</span><span class="params">(Unicde_Str)</span>:</span></span><br><span class="line">    Hex_Str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(Unicde_Str)):</span><br><span class="line">        Hex_Str += (hex(ord(Unicde_Str[i])).replace(<span class="string">'0x'</span>,<span class="string">''</span>).zfill(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">return</span> Hex_Str</span><br><span class="line"></span><br><span class="line">INFO = Unicode2HexStr(<span class="string">'你在干什么!!! 我一直在盯着你!!! 你给我小心点!!!'</span>)</span><br><span class="line">SEND_INFO = <span class="string">'AT+CTTS=1,'</span> + <span class="string">'"'</span> + INFO  + <span class="string">'"'</span></span><br><span class="line">PHONE_NUM = <span class="string">'ATD'</span> + <span class="string">'&#123;手机号&#125;'</span> + <span class="string">';'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SERIAL_PORT = <span class="string">"/dev/ttyUSB0"</span></span><br><span class="line"></span><br><span class="line">ser = serial.Serial(SERIAL_PORT, baudrate = <span class="number">115200</span>, timeout = <span class="number">5</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">"ATE1;\r"</span>.encode())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">"AT+COLP=1\r"</span>.encode())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">"AT+CTTSRING=0\r"</span>.encode())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">"AT+CTTSPARAM=20,0,50,75,1\r"</span>.encode())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">print(ser.read(ser.inWaiting()))</span><br><span class="line"></span><br><span class="line">ser.write((PHONE_NUM + <span class="string">'\r'</span>).encode())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ABC = <span class="number">0</span></span><br><span class="line">CBA = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> ABC != <span class="number">1</span>:</span><br><span class="line">    AA = ser.read(ser.inWaiting())</span><br><span class="line">    BB = AA.decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'+COLP'</span> <span class="keyword">in</span> BB <span class="keyword">and</span> <span class="string">'OK'</span> <span class="keyword">in</span> BB:</span><br><span class="line">        ser.write((SEND_INFO + <span class="string">'\r'</span>).encode())</span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        ser.write(<span class="string">"AT+CTTS=0\r"</span>.encode())</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        ABC = <span class="number">1</span></span><br><span class="line">    CBA += <span class="number">1</span></span><br><span class="line">    print(CBA)</span><br><span class="line">    <span class="keyword">if</span> CBA == <span class="number">50</span>:</span><br><span class="line">       ABC = <span class="number">1</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ser.write(<span class="string">"ATH\r"</span>.encode())</span><br><span class="line">ser.close()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="树莓派-python-模块"><a href="#树莓派-python-模块" class="headerlink" title="树莓派 python 模块"></a>树莓派 python 模块</h3><ol>
<li><p>pyserial</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Python中用于读串口的模块是&quot;pySerial&quot;</span><br><span class="line">读取串口时首先导入包&quot;import serial&quot;,其次设置读取哪一个口,波特率,数据位,停止位</span><br><span class="line"></span><br><span class="line">例如:</span><br><span class="line">class serial.Serial  </span><br><span class="line">    __init__( port=None,</span><br><span class="line">              baudrate=9600,</span><br><span class="line">              bytesize=EIGHTBITS,</span><br><span class="line">              parity=PARITY_NONE,</span><br><span class="line">              stopbits=STOPBITS_ONE,</span><br><span class="line">              timeout=None,</span><br><span class="line">              xonxoff=False,</span><br><span class="line">              rtscts=False,</span><br><span class="line">              writeTimeout=None,</span><br><span class="line">              dsrdtr=False,</span><br><span class="line">              interCharTimeout=None )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    baudrate：设置波特率</span><br><span class="line">    bytesize:数据位</span><br><span class="line">    stopbits:停止位</span><br><span class="line">    timeout:超时时间</span><br><span class="line">      timeout = None: 长时间等待</span><br><span class="line">      timeout = 0: 不阻塞形式 (读完之后就返回)</span><br><span class="line">      timeout = x: x秒后超时 (float allowed)</span><br><span class="line"></span><br><span class="line">例2:</span><br><span class="line">import serial           //导入模块</span><br><span class="line">ser = serial.Serial(0)  //打开第一个串口</span><br><span class="line">print ser.portstr       //能看到第一个串口的标识,windows下是COM1</span><br><span class="line">ser.write(&quot;hello&quot;)      //往串口里面写数据</span><br><span class="line">ser.close()             //关闭ser表示的串口</span><br><span class="line">ser.open()              //打开这个串口</span><br><span class="line">ser = serial.Serial(&apos;COM1&apos;, 115200)   //来设置波特率,当然还有专门的函数</span><br><span class="line">data = ser.read()       //可以读1个字符</span><br><span class="line">data = ser.read(20)     //可以读20个字符</span><br><span class="line">data = ser.readline()   //是读一行,以/n结束,要是没有/n就一直读,阻塞</span><br><span class="line">data = ser.readlines()和ser.xreadlines() //都需要设置超时时间</span><br><span class="line">ser.baudrate = 9600     //设置波特率</span><br><span class="line">ser                     //来查看当前串口的状态</span><br><span class="line">ser.isOpen()            //看看这个串口是否已经被打开</span><br></pre></td></tr></table></figure>
</li>
<li><p>RPi.GPIO</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">GPIO（General Purpose I/O Ports）意思为通用输入/输出端口,通俗地说,就是一些引脚,可以通过它们输出高低电平或者通过它们读入引脚的状态-是高电平或是低电平</span><br><span class="line">用户可以通过GPIO口和硬件进行数据交互(如UART),控制硬件工作(如LED、蜂鸣器等),读取硬件的工作状态信号(如中断信号)等</span><br><span class="line">掌握了GPIO,差不多相当于掌握了操作硬件的能力</span><br><span class="line"></span><br><span class="line">例如:</span><br><span class="line">import RPi.GPIO as GPIO   //导入RPi.GPIO模块</span><br><span class="line">或者:</span><br><span class="line">try:</span><br><span class="line">    import RPi.GPIO as GPIO</span><br><span class="line">except RuntimeError:</span><br><span class="line">    print(&quot;引入错误&quot;)</span><br><span class="line"></span><br><span class="line">在RPi.GPIO中,同时支持树莓派上的两种GPIO引脚编号:</span><br><span class="line">第一种编号是BOARD编号,这和树莓派电路板上的物理引脚编号相对应.使用这种编号的好处是,你的硬件将是一直可以使用的,不用担心树莓派的版本问题.因此,在电路板升级后,你不需要重写连接器或代码</span><br><span class="line">第二种编号是BCM规则,是更底层的工作方式,它和Broadcom的片上系统中信道编号相对应.在使用一个引脚时,你需要查找信道号和物理引脚编号之间的对应规则.对于不同的树莓派版本,编写的脚本文件也可能是无法通用的</span><br><span class="line"></span><br><span class="line">GPIO.setmode(GPIO.BOARD)  //指定BOARD编号</span><br><span class="line">或者</span><br><span class="line">GPIO.setmode(GPIO.BCM)    //指定BCM规则</span><br><span class="line"></span><br><span class="line">mode = GPIO.getmode()     //返回设置的引脚编号</span><br><span class="line"></span><br><span class="line">GPIO.setwarnings(False)   //禁用警告</span><br><span class="line"></span><br><span class="line">GPIO.setup(channel, GPIO.IN)  //将引脚设置为输入模式</span><br><span class="line">GPIO.setup(channel, GPIO.OUT) //将引脚设置为输出模式</span><br><span class="line">GPIO.setup(channel, GPIO.OUT, initial=GPIO.HIGH)  //为输出的引脚设置默认值</span><br><span class="line"></span><br><span class="line">GPIO.cleanup() //释放脚本中的使用的引脚(注意,GPIO.cleanup()只会释放掉脚本中使用的GPIO引脚,并会清除设置的引脚编号规则)</span><br><span class="line"></span><br><span class="line">GPIO.output(channel, state) //设置引脚的输出状态(状态可以设置为0,GPIO.LOW,False,1,GPIO.HIGH,True.如果编码规则为&quot;GPIO.BOARD&quot;,那么channel就是对应引脚的数字)</span><br><span class="line"></span><br><span class="line">一次性设置多个引脚:</span><br><span class="line">chan_list = [11,12]</span><br><span class="line">GPIO.output(chan_list, GPIO.LOW)</span><br><span class="line">GPIO.output(chan_list, (GPIO.HIGH, GPIO.LOW))</span><br><span class="line"></span><br><span class="line">你还可以使用Input()函数读取一个输出引脚的状态并将其作为输出值:</span><br><span class="line">GPIO.output(12, not GPIO.input(12))</span><br><span class="line"></span><br><span class="line">我们也常常需要读取引脚的输入状态,获取引脚输入状态如下代码：</span><br><span class="line">GPIO.input(channel)</span><br><span class="line">注意:低电平返回0,GPIO.LOW,False;高电平返回1,GPIO.HIGH.True</span><br><span class="line"></span><br><span class="line">如果输入引脚处于悬空状态,引脚的值将是漂动的.换句话说,读取到的值是未知的,因为它并没有被连接到任何的信号上,直到按下一个按钮或开关.由于干扰的影响,输入的值可能会反复的变化.解决方法:</span><br><span class="line">GPIO.setup(channel, GPIO.IN, pull_up_down=GPIO.PUD_UP)</span><br><span class="line">GPIO.setup(channel, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)</span><br><span class="line">注意: 上面的读取代码只是获取当前一瞬间的引脚输入信号</span><br><span class="line"></span><br><span class="line">如果需要实时监控引脚的状态变化,可以有两种办法:</span><br><span class="line">最简单原始的方式是每隔一段时间检查输入的信号值,这种方式被称为轮询.如果你的程序读取的时机错误,则很可能会丢失输入信号.轮询是在循环中执行的,这种方式比较占用处理器资源.</span><br><span class="line">另一种响应GPIO输入的方式是使用中断(边缘检测),这里的边缘是指信号从高到低的变换(下降沿)或从低到高的变换(上升沿)</span><br><span class="line"></span><br><span class="line">轮询方式:</span><br><span class="line">while GPIO.input(channel) == GPIO.LOW:</span><br><span class="line">    time.sleep(0.01)  # wait 10 ms to give CPU chance to do other things</span><br><span class="line"></span><br><span class="line">边缘检测:</span><br><span class="line">边缘是指信号状态的改变,从低到高(上升沿)或从高到低(下降沿).通常情况下,我们更关心于输入状态的该边而不是输入信号的值.这种状态的该边被称为事件</span><br><span class="line">先介绍两个函数:</span><br><span class="line">* wait_for_edge() 函数</span><br><span class="line">  wait_for_edge()被用于阻止程序的继续执行,直到检测到一个边沿.也就是说,上文中等待按钮按下的实例可以改写为:</span><br><span class="line">  channel = GPIO.wait_for_edge(channel, GPIO_RISING, timeout=5000)</span><br><span class="line">  if channel is None:</span><br><span class="line">      print(&apos;Timeout occurred&apos;)</span><br><span class="line">  else:</span><br><span class="line">      print(&apos;Edge detected on channel&apos;, channel)</span><br><span class="line"></span><br><span class="line">* add_event_detect() 函数</span><br><span class="line">  该函数对一个引脚进行监听,一旦引脚输入状态发生了改变,调用event_detected()函数会返回true,如下代码:</span><br><span class="line">  GPIO.add_event_detect(channel, GPIO.RISING)  # add rising edge detection on a channel</span><br><span class="line">  do_something()</span><br><span class="line">  // 下面的代码放在一个线程循环执行。</span><br><span class="line">  if GPIO.event_detected(channel):</span><br><span class="line">      print(&apos;Button pressed&apos;)</span><br><span class="line"></span><br><span class="line">  设置多个回调函数:</span><br><span class="line">  def my_callback_one(channel):</span><br><span class="line">      print(&apos;Callback one&apos;)</span><br><span class="line">  def my_callback_two(channel):</span><br><span class="line">      print(&apos;Callback two&apos;)</span><br><span class="line">  GPIO.add_event_detect(channel, GPIO.RISING)</span><br><span class="line">  GPIO.add_event_callback(channel, my_callback_one)</span><br><span class="line">  GPIO.add_event_callback(channel, my_callback_two)</span><br><span class="line">  注意:回调触发时,并不会同时执行回调函数,而是根据设置的顺序调用它们</span><br><span class="line"></span><br><span class="line">例如: 点亮LED灯</span><br><span class="line">import RPi.GPIO as GPIO  //引入函数库</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">RPi.GPIO.setmode(GPIO.BOARD)       //设置引脚编号规则</span><br><span class="line">RPi.GPIO.setup(11, RPi.GPIO.OUT)   //将11号引脚设置成输出模式</span><br><span class="line"></span><br><span class="line">while True</span><br><span class="line">    GPIO.output(channel, 1)   //将引脚的状态设置为高电平，此时LED亮了</span><br><span class="line">    time.sleep(1)             //程序休眠1秒钟，让LED亮1秒</span><br><span class="line">    GPIO.output(channel, 0)   //将引脚状态设置为低电平，此时LED灭了</span><br><span class="line">    time.sleep(1)             //程序休眠1秒钟，让LED灭1秒</span><br><span class="line"></span><br><span class="line">GPIO.cleanup()    //程序的最后别忘记清除所有资源</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>00310035003200300031003600380034003200320033<br>00480065006C006C006F002C5218670B</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/07/24/树莓派-GSM-语音和短信报警/" data-id="cjavy9k9800ck0coqe77avx87" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-RabbitMQ-working-principle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/19/RabbitMQ-working-principle/" class="article-date">
  <time datetime="2017-07-19T09:20:05.000Z" itemprop="datePublished">2017-07-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hadoop/">hadoop</a>►<a class="article-category-link" href="/categories/hadoop/RabbitMQ/">RabbitMQ</a>►<a class="article-category-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-working-principle/">RabbitMQ working principle</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/RabbitMQ-working-principle/">RabbitMQ working principle</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="RabbitMQ-工作原理"><a href="#RabbitMQ-工作原理" class="headerlink" title="RabbitMQ 工作原理"></a>RabbitMQ 工作原理</h3><ol>
<li><p>RabbitMQ 简介</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 开源AMQP实现,Erlang语言编写,支持多种客户端</span><br><span class="line">* 分布式,高可用,持久化,可靠,安全</span><br><span class="line">* 支持多种协议: AMQP,STOMP,MQTT,HTTP</span><br><span class="line">* RabbitMQ主要概念对象: 生产者,消费者,交换机,队列</span><br><span class="line">* 业务解耦: 解决多系统,易购系统间的数据交换,解耦生产者和消费者</span><br><span class="line">* 适用场景: 批量数据异步处理,并行任务串行化,高负载任务负载均衡</span><br></pre></td></tr></table></figure>
</li>
<li><p>RabbitMQ 核心概念<br><img src="RabbitMQ-working-principle/AMQP基本概念图.jpg" alt="AMQP基本概念图"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* 颗粒度</span><br><span class="line">  * Broker</span><br><span class="line">    接收和分发消息的应用,RabbitMQ Server就是Message Broker</span><br><span class="line"></span><br><span class="line">  * Virtual host</span><br><span class="line">    虚拟主机(虚拟组),一个Broker可以开设多个vhost.因为RabbitMQ当中,用户只能在虚拟主机的粒度进行权限控制.</span><br><span class="line">    当多个不同的用户使用同一个RabbitMQ server提供的服务时,可以划分出多个vhost,每个用户在自己的vhost创建exchange和queue等</span><br><span class="line"></span><br><span class="line">  * Exchange 消息交换机</span><br><span class="line">    message到达broker的第一站,根据分发规则,匹配查询表中的routing key,分发消息到queue中去</span><br><span class="line">    常用的类型有:direct(point-to-point),topic(publish-subscribe),fanout(multicast)</span><br><span class="line"></span><br><span class="line">  * Queue 消息队列载体</span><br><span class="line">    消息最终被送到这里等待consumer取走.一个message可以被同时拷贝到多个queue中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* 消息流转</span><br><span class="line">  * Binding 绑定,根据路由规则绑定Exchange和Queue</span><br><span class="line">    exchange和queue之间的虚拟连接,binding中可以包含routing key</span><br><span class="line">    Binding信息被保存到exchange中的查询表中,用于message的分发依据</span><br><span class="line"></span><br><span class="line">  * Routing Key 路由关键字</span><br><span class="line"></span><br><span class="line">  * Connection 连接</span><br><span class="line">    Publisher/Consumer和broker之间的TCP连接</span><br><span class="line">    断开连接的操作只会在client端进行,Broker不会断开连接,除非出现网络故障或broker服务出现问题</span><br><span class="line"></span><br><span class="line">  * Channel 消息通道,每个连接可建立多个channel</span><br><span class="line">    如果每一次访问RabbitMQ都建立一个Connection,在消息量大的时候建立TCP Connection的开销将是巨大的,效率也较低.Channel是在connection内部建立的逻辑连接,如果应用程序支持多线程,通常每个thread创建单独的channel进行通讯,AMQP method包含了&quot;channel id&quot;帮助客户端和&quot;message broker&quot;识别channel,所以channel之间是完全隔离的.Channel作为轻量级的Connection极大减少了操作系统建立TCP connection的开销</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* 关联对象</span><br><span class="line">  * Producter 消息生产者</span><br><span class="line">  * Consumer  消息消费者</span><br></pre></td></tr></table></figure>
</li>
<li><p>RabbitMQ典型生产消费消息模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">生产者发送消息到broker server(RabbitMQ).在Broker内部,用户创建Exchange/Queue,通过Binding规则将两者联系在一起.Exchange分发消息,根据类型/binding的不同,分发策略有所区别.消息最后来到Queue中,等待消费者取走</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-working-principle/RabbitMQ典型生产消费消息模型.jpg" alt="RabbitMQ典型生产消费消息模型"></p>
<ol>
<li>RabbitMQ 交换机类型- Direct Exchange<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Direct Exchange 路由机制: 通过精确匹配消息的路由关键字,将消息路由到零个或者多个队列中,绑定关键字用来将队列和交换器绑定在一起</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-working-principle/Exchange.Direct.jpg" alt="Exchange.Direct"></p>
<ol>
<li>RabbitMQ 交换机类型- Topic Exchange<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Topic Exchange 路由机制: 通过消息的路由关键字和绑定关键字的模式匹配,将消息路由到被绑定的队列中.这种路由器类型可以被用来支持经典的发布/订阅消息传输模式</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-working-principle/Exchange.Topic.jpg" alt="Exchange.Topic"></p>
<ol>
<li>RabbitMQ 交换机类型- Fanout Exchange<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fanout Exchange 路由机制: 不论消息的路由关键字是什么,这条信息都会被路由到所有与该交换机绑定的队列中</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-working-principle/Exchange.Fanout.jpg" alt="Exchange.Fanout"></p>
<ol>
<li>RabbitMQ 交换机类型- Headers Exchange<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Headers Exchange 路由机制: 键值对匹配路由</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="RabbitMQ-working-principle/Exchange.Headers.jpg" alt="Exchange.Headers"></p>
<ol>
<li><p>操作流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(1)  消费者创建消息队列</span><br><span class="line">(2)  消费者定义消息队列</span><br><span class="line">(3)  消费者定义特定类型的交换机</span><br><span class="line">(4)  消费者设定绑定规则</span><br><span class="line">(5)  等待消息</span><br><span class="line">(6)  生产者创建消息</span><br><span class="line">(7)  生产者将消息投递至信息通道中</span><br><span class="line">(8)  交换机获取消息</span><br><span class="line">(9)  消费者获取并处理消息，并发送反馈</span><br><span class="line">(10) 结束，关闭通道和连接</span><br></pre></td></tr></table></figure>
</li>
<li><p>实践保障和规划</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//保障</span><br><span class="line">* 复用connection,复用channel</span><br><span class="line">* 如果需要可靠业务,需要持久化和ack机制</span><br><span class="line">* 如果希望高吞吐,可以采取非持久化,noack,自动删除机制</span><br><span class="line">* 稳定性保障: 生产者异常保障,消费者异常保障</span><br><span class="line"></span><br><span class="line">//规划</span><br><span class="line">* 生产者面对Exchange,消费者面对queue</span><br><span class="line">* 一个queue只有一个消费者(可多个副本)进行处理</span><br><span class="line">* 命名规划:</span><br><span class="line">  - exchange: ex_&#123;业务对象&#125;_&#123;业务场景&#125;</span><br><span class="line">  - routekey: &#123;事件,某个业务动作&#125;</span><br><span class="line">  - queue: ex_&#123;业务对象&#125;_&#123;业务场景&#125;_&#123;事件&#125;</span><br><span class="line">* 串行或并行业务方案</span><br><span class="line">  - 并行方案: 一个事件发生后,多个消费者相互间没有依赖关系,可由Exchange分发消息到多个队列,由各队列的消费者并行进行处理</span><br><span class="line">  - 串行方案: 一个事件发生后,多个消费者有先后依赖关系,可以由先执行的消费者处理事情,处理完成后再次发送消息到exchange,由后续的队列进行处理</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用场景-异步处理<br><strong>场景说明:</strong> 用户注册后,需要发注册邮件和注册短信,传统的做法有两种:</p>
<ol>
<li>串行的方式<br>将注册信息写入数据库后,发送注册邮件,再发送注册短信,以上三个任务全部完成后才返回给客户端<br>这有一个问题是,邮件,短信并不是必须的,它只是一个通知,而这种做法让客户端等待没有必要等待的东西.<br><img src="RabbitMQ-working-principle/异步处理串行.jpg" alt="异步处理串行"></li>
<li>并行的方式<br>将注册信息写入数据库后,发送邮件的同时发送短信,以上三个任务完成后,返回给客户端,并行的方式能提高处理的时间<br><img src="RabbitMQ-working-principle/异步处理并行.jpg" alt="异步处理并行"></li>
<li>引入消息队列<br>引入消息队列后,把发送邮件,短信不是必须的业务逻辑异步处理.用户的响应时间就等于写入数据库的时间+写入消息队列的时间,响应时间是串行的3倍,是并行的2倍<br><img src="RabbitMQ-working-principle/异步处理消息队列.jpg" alt="异步处理消息队列"></li>
</ol>
</li>
<li><p>应用场景-应用解耦<br><strong>场景说明:</strong> 双11是购物狂节,用户下单后,订单系统需要通知库存系统,传统的做法就是订单系统调用库存系统的接口.这种做法有一个缺点,当库存系统出现故障时,订单就会失败<br><img src="RabbitMQ-working-principle/应用解耦传统模式.jpg" alt="应用解耦传统模式"><br>引入消息队列,订单系统(用户下单后,订单系统完成持久化处理,将消息写入消息队列,返回用户订单下单成功),库存系统(订阅下单的消息,获取下单消息,进行库操作),就算库存系统出现故障,消息队列也能保证消息的可靠投递,不会导致消息丢失<br><img src="RabbitMQ-working-principle/应用解耦引入消息队列.jpg" alt="应用解耦引入消息队列"></p>
</li>
<li><p>应用场景-流量削峰<br><strong>场景说明:</strong> 流量削峰一般在秒杀活动中应用广泛.秒杀活动,一般会因为流量过大,导致应用挂掉,为了解决这个问题,一般在应用前端加入消息队列.一方面可以控制活动人数,超过此一定阀值的订单直接丢弃;另一方面可以缓解短时间的高流量压垮应用(应用程序按自己的最大处理能力获取订单)<br>引入消息队列后,用户的请求,服务器收到之后,首先写入消息队列,加入消息队列长度超过最大值,则直接抛弃用户请求或跳转到错误页面.秒杀业务根据消息队列中的请求信息,再做后续处理.<br><img src="RabbitMQ-working-principle/流量消峰引入消息队列.jpg" alt="流量消峰引入消息队列"></p>
</li>
<li><p>RabbitMQ 系统架构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">* Round-robin dispathching 循环分发</span><br><span class="line">  RabbbitMQ的分发机制非常适合扩展,而且它是专门为并发程序设计的,如果现在load加重,那么只需要创建更多的Consumer来进行任务处理</span><br><span class="line"></span><br><span class="line">* Message acknowledgment 消息确认</span><br><span class="line">  为了保证数据不被丢失,RabbitMQ支持消息确认机制,为了保证数据能被正确处理,而不仅仅是被Consumer收到,那么我们不能采用no-ack,而应该是在处理完数据之后发送ack.</span><br><span class="line">  在处理完数据之后发送ack,就是告诉RabbitMQ数据已经被接收,处理完成,RabbitMQ可以安全的删除它了.如果Consumer退出了但是没有发送ack,那么RabbitMQ就会把这个Message发送到下一个Consumer,这样就保证在Consumer异常退出情况下数据也不会丢失.</span><br><span class="line">  RabbitMQ它没有用到超时机制.RabbitMQ仅仅通过Consumer的连接中断来确认该Message并没有正确处理,也就是说RabbitMQ给了Consumer足够长的时间做数据处理.如果忘记ack,那么当Consumer退出时,Mesage会重新分发,然后RabbitMQ会占用越来越多的内存.</span><br><span class="line"></span><br><span class="line">* Message durability 消息持久化</span><br><span class="line">  要持久化队列(queue)的持久化需要在声明时指定&quot;durable=True;&quot;</span><br><span class="line">  这里要注意,队列的名字一定要是Broker中不存在的,不然不能改变此队列的任何属性.</span><br><span class="line"></span><br><span class="line">  队列和交换机有一个创建时候指定的标志durable,durable的唯一含义就是具有这个标志的队列和交换机会在重启之后重新建立,它不表示说在队列中的消息会在重启后恢复</span><br><span class="line"></span><br><span class="line">  消息持久化包括3部分:</span><br><span class="line">  1.exchange持久化,在声明时指定&quot;durable =&gt; true&quot;</span><br><span class="line">  2.queue持久化,在声明时指定&quot;durable =&gt; true&quot;</span><br><span class="line">  3.消息持久化,在投递时指定&quot;delivery_mode =&gt; 2&quot; (1是非持久化)</span><br><span class="line">  注意:</span><br><span class="line">  * 如果exchange和queue都是持久化的,那么它们之间的binding也是持久化的</span><br><span class="line">  * 如果exchange和queue两者之间有一个持久化,一个非持久化,则不允许建立绑定</span><br><span class="line">  * 一旦创建了队列和交换机,就不能修改其标志了.例如,创建了一个non-durable的队列,然后想把它改变成durable的,唯一的办法就是删除这个队列然后重现创建</span><br><span class="line"></span><br><span class="line">* Fair dispath 公平分发</span><br><span class="line">  分发机制默认状态下不是那么优雅: RabbitMQ将第N个Message分发给第N个Consumer.N是取余后的,它不管Consumer是否还有&quot;unacked Message&quot;,只是按照这个默认的机制进行分发.如果有个Consumer工作比较重,那么就会导致有的Consumer基本没事可做,有的Consumer却毫无休息的机会</span><br><span class="line"></span><br><span class="line">  解决方法:</span><br><span class="line">  公平分发: 通过basic.qos方法设置&quot;prefetch_count=1&quot;,这样RabbitMQ就会使得每个Consumer在同一个时间点最多处理一个Message,换句话说,在接收到该Consumer的ack前,它不会将新的Message分发给它</span><br><span class="line">  注意: 这种方法可能会导致queue爆满.当然,这种情况下你可能需要添加更多的Consumer,或者创建更多的virtual Host来细化你的设计</span><br><span class="line"></span><br><span class="line">* 分发到多个Consumer</span><br><span class="line">  重温交换机类型:</span><br><span class="line">  * Direct Exchange</span><br><span class="line">    直接匹配,通过Exchange名称+Rounting Key来发送与接收消息</span><br><span class="line">  * Fanout Exchange</span><br><span class="line">    广播订阅,向所有的消费者发布消息,但是只有消费者将队列绑定到该路由器才能收到消息,忽略Routing Key</span><br><span class="line">  * Topic Exchange</span><br><span class="line">    主题匹配订阅,这里的主题指的是Routing Key,Routing Key可以采用通配符,如:*或#,RoutingKey命名采用&quot;.&quot;来分隔多个词,只有消息这将队列绑定到该路由器且指定Routing Key符合匹配规则时才能收到消息</span><br><span class="line">  * Headers Exchange</span><br><span class="line">    消息头订阅,消息发布前,为消息定义一个或多个键值对的消息头,然后消费者接收消息同时需要定义类似的键值对请求头:(如:x-mactch=all或者x_match=any),只有请求头与消息头匹配,才能接收消息,忽略RoutingKey.</span><br><span class="line">  * 默认的exchange</span><br><span class="line">    如果用空字符串去声明一个exchange,那么系统就会使用&quot;amq.direct&quot;这个exchange.我们创建一个queue时,默认的都会有一个和新建queue同名的routing Key绑定到这个默认的exchange上去</span><br><span class="line"></span><br><span class="line">  如果有两个接收程序都是用了同一个的queue和相同的routingKey去绑定direct exchange的话,分发的行为是负载均衡的,也就是说第一个是程序1收到,第二个是程序2收到,以此类推</span><br><span class="line">  如果有两个接收程序用了各自的queue,但使用相同的routingKey去绑定direct exchange的话,分发的行为是复制的,也就是说每个程序都会收到这个消息的副本.行为相当于fanout类型的</span><br><span class="line"></span><br><span class="line">* 消息序列化</span><br><span class="line">  RabbitMQ使用ProtoBuf序列化消息,它可作为RabbitMQ的Message的数据格式进行传输,由于是结构化的数据,这样就极大的方便了Consumer的数据高效处理,当然也可以使用XML,与XML相比,ProtoBuf有优势.</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/07/19/RabbitMQ-working-principle/" data-id="cjavy9jtv000s0coqdqppaem9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-RabbitMQ-high-availability" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/19/RabbitMQ-high-availability/" class="article-date">
  <time datetime="2017-07-19T07:37:23.000Z" itemprop="datePublished">2017-07-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hadoop/">hadoop</a>►<a class="article-category-link" href="/categories/hadoop/RabbitMQ/">RabbitMQ</a>►<a class="article-category-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-high-availability/">RabbitMQ high availability</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/RabbitMQ-high-availability/">RabbitMQ high availability</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="RabbitMQ-高可用方案"><a href="#RabbitMQ-高可用方案" class="headerlink" title="RabbitMQ 高可用方案"></a>RabbitMQ 高可用方案</h3><ol>
<li><p>Rabbit集群方案一: 普通模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">普通模式:</span><br><span class="line">exchange,buindling在所有的节点上都会保存一份,但queue只会存储在其中的一个节点上,同时所有的节点还都会存储一份queue的meta信息.</span><br><span class="line">因为这样有两个好处:</span><br><span class="line">1.存储空间</span><br><span class="line">  如果每一个节点上都有全部的消息,有多少个节点就会有多少个消息总量的&quot;拷贝&quot;.</span><br><span class="line">  假如一个队列的消息占用的空间是1G,那么三个节点就是3G</span><br><span class="line">2.性能</span><br><span class="line">  * 消息需要在节点之间传输会有很大的网络开销</span><br><span class="line">  * 如果消息设置了durable(即,持久化),还会增加很大的磁盘负载</span><br><span class="line"></span><br><span class="line">队列存储的节点 取决于 创建队列的客户端当时所连接的节点.如果生产者连接的是另外一个节点,将会把消息转发到存储该队列的节点上.如果消费者连接了非存储队列的节点取数据,消费者从存储消息的节点拉去数据.</span><br><span class="line">所以:</span><br><span class="line">1.创建队列都连到了一个节点上,所有的队列都存储在一个节点上</span><br><span class="line">2.存消息的节点挂掉了,consumer只能等到节点恢复后才能读到消息</span><br><span class="line">3.设A,B节点,queue数据在A上,可以向A或B生产或消费消息.一旦往B生产消息时A挂了,client不会收到任何错误信息并继续发送,而实际上消息是被丢弃了.而此时如果client也挂了,再连接B时会报节点A不存在而失败.在B读也是类似的,在client批量取到的数据读完之前是不会知道A有没有挂掉,等到读取下一批数据时一旦A挂掉会报错</span><br><span class="line">所以这种集群方法的特点是：高吞吐量,非高可用</span><br></pre></td></tr></table></figure>
</li>
<li><p>Rabbit集群方案一: 镜像模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">镜像模式:</span><br><span class="line"></span><br><span class="line">镜像模式和普通模式的区别:</span><br><span class="line">队列的数据都镜像了一份到所有的节点上.这样任何一个节点失效,不会影响整个集群的使用</span><br><span class="line"></span><br><span class="line">在实现上,镜像队列内部有一套选举算法,会选出一个master和若干个slaver.master和slaver通过相互间不断发送心跳来检查是否连接断开.可以通过指定net_ticktime来控制心跳检查频率.注意一个单位时间net_ticktime实际上做了4次交互,故当超过net_ticktime(± 25%)秒没有响应的话则认为节点挂掉.另外注意修改net_ticktime时需要所有节点都一致:</span><br><span class="line">配置举例:</span><br><span class="line">[</span><br><span class="line">  &#123;rabbit, [&#123;tcp_listeners, [5672]&#125;]&#125;,</span><br><span class="line">  &#123;kernel, [&#123;net_ticktime,  120&#125;]&#125;</span><br><span class="line">].</span><br><span class="line"></span><br><span class="line">consumer,任意连接一个节点,若连上的不是master,请求会转发给master,为了保证消息的可靠性,consumer回复ack给master后,master删除消息并广播所有的slaver去删除.</span><br><span class="line"></span><br><span class="line">publisher,任意连接一个节点,若连上的不是master,则转发给master,由master存储并转发给其他的slaver存储.如果master挂掉,则从slaver中选择消息队列最长的为master,在这种情况下可以存在消息未同步,给ack消息未同步的情况,会造成消息重发(默认是异步同步的).</span><br><span class="line">总共有以下几件事情发生：</span><br><span class="line">1.1个最老的(队列最长的)的slaver提升为master,如果没有一个slaver是和master同步的则会造成消息丢失</span><br><span class="line">2.要提升为master的slaver会认为以前所有连接挂掉的master的消费者都断开了连接.那么存在clinet发送了ack的消息但还在路上是master挂掉的情况,或者master收到了ack但是在广播给slaver的时候master挂掉的情况,所以新的master别无选择,只能认为消息没有被确认.他会requeue他认为没有ack的消息.那么client可能就收到了重复的消息,并要再次发送ack</span><br><span class="line">3.从镜像队列中消费的client支持了consumer Cancellation通知的,将收到通知并订阅的mirrored-queue被取消了,这是因为该mirrored-queue升级成了master,这是client需要重现去找mirrored-queue上消费,这样就避免了client继续发送ack到老的挂掉的master上.避免收到新的master发送的相同的消息.</span><br><span class="line">4.如果noAck=true,且在mirrored-queue上消费,那么在切换时由于服务器是先ack然后发送到noAck=true的消费者,这时连接断开可能导致该数据丢失</span><br><span class="line"></span><br><span class="line">如果slaver挂掉,则集群的节点状态没有任何变化.只要client没有连到这个节点上,也不会给client发送失败的通知.在检测到slaver挂掉的期间publish消息会有延迟.如果配置了高可用策略是自动同步,当slaver起来后,队列中有大量的消息需要同步,将会整个集群阻塞长时间的不能读写直到同步结束.</span><br><span class="line"></span><br><span class="line">这两个挂掉的情况都需要客户端镜像容错,比如在连接断开的时候进行重连(官方的Java和.net 客户端提供了callback方法在监听到链接失败的时候调用.Java在Connection和channel类中提供了ShutdownListener 的callback方法,.net client在IConnecton中提供了ConnectionShuedown在Imodel中提供了ImodelShutdown事件供调用).也可以在client和server之间加入LoadBalancer.比如haproxy做负载均衡</span><br><span class="line"></span><br><span class="line">指定mirror策略:</span><br><span class="line">有三种策略:</span><br><span class="line">* all</span><br><span class="line">  队列将mirrored到所有集群中的节点中,当新节点添加进来时也会mirrored到新的节点</span><br><span class="line">* exactly(需指定count)</span><br><span class="line">  如果节点数小于count数,则队列将mirrored到所有的节点.如果节点数大于count,新的节点将不再创建队列的mirror(即使原来已创建mirror的节点挂掉也不会创建)</span><br><span class="line">* nodes</span><br><span class="line">  对指定的节点进行mirror.如果没有一个指定的节点在运行中,那么只有client连接的那个节点才会声明queue(这里有个迁移策略:假如queue是在[A,B]上且A为master,若给定的新的策略为nodes[C,D],那么为了防止数据丢失,在迁移中会同时存在[A,C,D]直到C,D已经同步好以后,A才会关闭)</span><br><span class="line"></span><br><span class="line">配置举例:</span><br><span class="line">设置queue的名称为ha.的为高可用:</span><br><span class="line">linux:rabbitmqctl set_policy ha-all &quot;^ha\.&quot; &apos;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&apos;</span><br><span class="line">win:rabbitmqctl set_policy ha-all &quot;^ha\.&quot; &quot;&#123;&quot;&quot;ha-mode&quot;&quot;:&quot;&quot;all&quot;&quot;&#125;&quot;</span><br><span class="line">http api:PUT /api/policies/%2f/ha-all &#123;&quot;pattern&quot;:&quot;^ha\.&quot;, &quot;definition&quot;:&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#125;</span><br><span class="line">web ui:</span><br><span class="line">1:Navigate to Admin &gt; Policies &gt; Add / update a policy.</span><br><span class="line">2:Enter &quot;ha-all&quot; next to Name, &quot;^ha\.&quot; next to Pattern, and &quot;ha-mode&quot; = &quot;all&quot; in the first line next to Policy.</span><br><span class="line">3:Click Add policy.</span><br><span class="line"></span><br><span class="line">举例2：</span><br><span class="line">rabbitmqctl set_policy ha-two &quot;^two\.&quot; \</span><br><span class="line">   &apos;&#123;&quot;ha-mode&quot;:&quot;exactly&quot;,&quot;ha-params&quot;:2,&quot;ha-sync-mode&quot;:&quot;automatic&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line">自动或手动同步：</span><br><span class="line">你可以查看哪些slave已经同步好了：</span><br><span class="line">rabbitmqctl list_queues name slave_pids synchronised_slave_pids</span><br><span class="line"></span><br><span class="line">你可以手动同步(默认手动同步)：</span><br><span class="line">rabbitmqctl sync_queue name</span><br><span class="line"></span><br><span class="line">你可以取消自动同步：</span><br><span class="line">rabbitmqctl cancel_sync_queue name</span><br><span class="line">一个没有同步的mirror，它仍然会同步后续插入队列的数据，但是队列前面的数据却没有。但是随着队列的不断消费，导致空缺的部分的消息被消费掉了，此时mirror也可以是同步了的。</span><br></pre></td></tr></table></figure>
</li>
<li><p>Rabbit集群方案一: 主备模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">主备模式:</span><br><span class="line">主备方式(active,passive)只有一个节点处于服务状态,可以结合pacemaker和ARBD,shovel简单从一个broker的一个队列中消费消息,且转发该消息到另一个broker的交换机.</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.smallasa.com/2017/07/19/RabbitMQ-high-availability/" data-id="cjavy9jtm000k0coqy5pdts8l" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/9/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AliCloud/">AliCloud</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/AliCloud/SDK/">SDK</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/AliCloud/SDK/Python-SDK/">Python SDK</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Android-install/">Android install</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Android-install/Android-studio-install/">Android studio install</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/">Development</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/">Doc</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/HTTP-严格传输安全HSTS/">HTTP 严格传输安全HSTS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/HTTP协议/">HTTP协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/TCP-协议详解/">TCP 协议详解</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/TCP与socket区别/">TCP与socket区别</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/linux-文件描述符与打开文件之间的关系/">linux 文件描述符与打开文件之间的关系</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/linux-文件系统inode/">linux 文件系统inode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Development/Doc/一次完整的HTTP请求/">一次完整的HTTP请求</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Disk/">Disk</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Disk/disk-io-performance/">disk io performance</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Disk/disk-iostat/">disk iostat</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-storage/">Distributed storage</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-storage/GlusterFS/">GlusterFS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-storage/GlusterFS/GlusterFS-architecture/">GlusterFS architecture</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-storage/GlusterFS/GlusterFS-info/">GlusterFS info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-storage/GlusterFS/GlusterFS-install/">GlusterFS install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-storage/GlusterFS/GlusterFS-workflow/">GlusterFS workflow</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/HA/">HA</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HA/DRBD/">DRBD</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HA/DRBD/DRBD-install/">DRBD install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/HA/keepalived/">keepalived</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HA/keepalived/keepalived-install/">keepalived install</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/">IDE</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/Intellij/">Intellij</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/Intellij/Intellij-setting/">Intellij setting</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/vim/">vim</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/vim/vim-shortcut-key/">vim shortcut key</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/vim/vim-vimrc/">vim vimrc</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel/">Kernel</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel/kernel-memory/">kernel memory</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel/kernel-memory/kernel-共享内存/">kernel 共享内存</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/">Monitor</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/ganglia/">ganglia</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/ganglia/ganglia-install/">ganglia install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/hmonitor/">hmonitor</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/hmonitor/hmonitor-install/">hmonitor install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/htmonitor/">htmonitor</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/htmonitor/htmonitor-install/">htmonitor install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/smokeping/">smokeping</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/smokeping/smokeping-install/">smokeping install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/">zabbix</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/monitor/">monitor</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/monitor/zabbix-monitor-cpu/">zabbix monitor cpu</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/monitor/zabbix-monitor-mem/">zabbix monitor mem</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-auto-discover/">zabbix auto discover</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-grafana-install/">zabbix grafana install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-install/">zabbix install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-install-distributed/">zabbix install distributed</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-item-and-tigger/">zabbix item and tigger</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-java-gateway/">zabbix java gateway</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-modify-login-user-passwd/">zabbix modify login user passwd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-optimization/">zabbix optimization</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-proxy-install/">zabbix proxy install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-server-support-chinese/">zabbix server support chinese</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/zabbix/zabbix-windows-agent/">zabbix windows agent</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/树莓派/">树莓派</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/树莓派/树莓派-GSM-语音短信报警/">树莓派 GSM 语音短信报警</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/监控/">监控</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Monitor/监控/监控知识体系/">监控知识体系</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Framework/">Python Framework</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Framework/Python-Django/">Python Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Framework/Python-Django-setting/">Python Django setting</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Framework/Python-tornado-install/">Python tornado install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/">Python Learn</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-上下文管理器/">python 上下文管理器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-内存管理/">python 内存管理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-函数编程/">python 函数编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-变量/">python 变量</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-对象使用/">python 对象使用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-对象的属性/">python 对象的属性</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-对象编程/">python 对象编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-数据类型/">python 数据类型</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-流程控制/">python 流程控制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-爬虫/">python 爬虫</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-特殊方法/">python 特殊方法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-特殊说明/">python 特殊说明</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-装饰器/">python 装饰器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-过程编程/">python 过程编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-进阶/">python 进阶</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-Learn/python-闭包/">python 闭包</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/">Python install</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-error-info/">python error info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-pip-source-image/">python pip source image</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-pip-use/">python pip use</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-pyenv-install/">python pyenv install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-setup-py/">python setup.py</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-source-install/">python source install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-install/python-virtualenv/">python virtualenv</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-library/">Python library</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-library/MySQLdb/">MySQLdb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-library/memory-profiler/">memory_profiler</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-library/time-datetime-calendar/">time datetime calendar</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-modules/">Python modules</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-modules/python-modules-path/">python modules path</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-modules/python-modules-pylint-and-ipython/">python modules pylint and ipython</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-other/">Python other</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python-other/python-import-and-reload/">python import and reload</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/">Ruby</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/Ruby-install/">Ruby install</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Ruby/Ruby-install/Ruby-install/">Ruby install</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP.IP</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/TCP-状态/">TCP 状态</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/TCP-IP模型/">TCP/IP模型</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/Wireshark-use/">Wireshark use</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/WeChat/">WeChat</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WeChat/WeChat-enterprise/">WeChat enterprise</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WeChat/WeChat-enterprise/WeChat-enterprise-API/">WeChat enterprise API</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/">automation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/">git</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-command/">git command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-error/">git error</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-gitlab/">git gitlab</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-gitolite/">git gitolite</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-gogs/">git gogs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-gogs-source-install/">git gogs source install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-init/">git init</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/git/git-workflow/">git workflow</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/jenkins/">jenkins</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/jenkins/jenkins-info/">jenkins info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/jenkins/jenkins-install/">jenkins install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/kvm/">kvm</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/kvm/kvm-install/">kvm install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/maven/">maven</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/maven/maven-install/">maven install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/nexus/">nexus</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/nexus/nexus-install/">nexus install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/nexus/nexus-proxy-maven/">nexus proxy maven</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/rpm/">rpm</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/rpm/rpm-package-build/">rpm package build</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/rpm/rpmbuild-spec/">rpmbuild spec</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/">salt</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-advanced-topic/">salt advanced topic</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-highstate/">salt highstate</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-info/">salt info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-install/">salt install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-install-HA/">salt install HA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-install-distributed/">salt install distributed</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-install-standard/">salt install standard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-jinja2-grain-pillar-module/">salt jinja2 grain pillar module</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-event-reactor/">salt manage event reactor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-grains/">salt manage grains</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-job/">salt manage job</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-module/">salt manage module</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-pillar/">salt manage pillar</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-return/">salt manage return</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-states/">salt manage states</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-manage-target/">salt manage target</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-master-syndic-install/">salt master syndic install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-master-conf/">salt master.conf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-minion-conf/">salt minion.conf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-raet/">salt raet</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-state-module/">salt state module</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-syndic-conf/">salt syndic.conf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/salt/salt-write-module-code/">salt write module code</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/svn/">svn</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/svn/svn-auto-update/">svn auto update</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/automation/yum/">yum</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/automation/yum/yum-server-install/">yum server install</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mongo/">Mongo</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mongo/mongo-auth/">mongo auth</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mongo/mongo-error/">mongo error</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mongo/mongo-replication-auth-install/">mongo replication auth install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mongo/mongo-replication-standard-install/">mongo replication standard install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mongo/mongo-standard-install/">mongo standard install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/">Mysql</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-command/">mysql command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-error-info/">mysql error info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-explain/">mysql explain</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-grant/">mysql grant</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-index-options/">mysql index options</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-innodb-buffer-pool-flush/">mysql innodb buffer pool flush</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-master-slave/">mysql master slave</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-master-slave-switch/">mysql master slave switch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-partition/">mysql partition</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-select-join/">mysql select join</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-slow-log/">mysql slow log</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-standard/">mysql standard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-table-size/">mysql table size</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Mysql/mysql-use-memory-as-disk/">mysql use memory as disk</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/">Postgresql</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-book-use/">postgresql book use</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-master-slave-info/">postgresql master slave info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-master-slave/">postgresql master/slave</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-plugin-install/">postgresql plugin install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-standard/">postgresql standard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-tablespace-database-schema-table-user-role-relation/">postgresql tablespace database schema table user role relation</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-yum-install/">postgresql yum install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-常用命令/">postgresql 常用命令</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-数据库对象/">postgresql 数据库对象</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Postgresql/postgresql-数据库管理/">postgresql 数据库管理</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Redis/">Redis</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/Redis/redis-error/">redis error</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Redis/redis-install/">redis install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Redis/redis-redis-trib-rb/">redis redis-trib.rb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Redis/redis-status/">redis status</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/Redis/redis-use/">redis use</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/influxDB/">influxDB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/database/influxDB/influxDB-install/">influxDB install</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/golang/go-env/">go env</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/">RabbitMQ</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-cluster/">RabbitMQ cluster</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-high-availability/">RabbitMQ high availability</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-info/">RabbitMQ info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-install/">RabbitMQ install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-python-pika/">RabbitMQ python pika</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-user-and-grant/">RabbitMQ user and grant</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/RabbitMQ/RabbitMQ-working-principle/">RabbitMQ working principle</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/beats/">beats</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/beats/beats-install/">beats install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/datax/">datax</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/datax/datax-info/">datax info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/datax/datax-install/">datax install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/datax/datax-job/">datax job</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/">elasticsearch</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-backup-and-restore/">elasticsearch backup and restore</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-command/">elasticsearch command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-core-component/">elasticsearch core component</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-exploring-your-cluster/">elasticsearch exploring your cluster</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-exploring-your-data/">elasticsearch exploring your data</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-four-search-type/">elasticsearch four search type</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-full-cluster-restart-upgrade/">elasticsearch full cluster restart upgrade</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-install/">elasticsearch install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-modifying-your-data/">elasticsearch modifying your data</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-rolling-upgrades/">elasticsearch rolling upgrades</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-safe-restart/">elasticsearch safe restart</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/elasticsearch-shard/">elasticsearch shard</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/how-to-tune-for-indexing-speed/">how to tune for indexing speed</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/elasticsearch/how-to-tune-for-search-speed/">how to tune for search speed</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/flume/">flume</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/flume/flume-info/">flume info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/flume/flume-install/">flume install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/grafana/">grafana</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/grafana/grafana-install/">grafana install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/hadoop/">hadoop</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/hadoop/hadoop-简介/">hadoop 简介</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/">kafka</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-add-topic-partition/">kafka add topic partition</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-add-topic-replicats/">kafka add topic replicats</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-broker-config/">kafka broker config</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-high-throughput/">kafka high throughput</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-info/">kafka info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-install/">kafka install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-manage-web/">kafka manage web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-migrate-and-scale/">kafka migrate and scale</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-offset-monitor/">kafka offset monitor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-optimize/">kafka optimize</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-use/">kafka use</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-web-console/">kafka web console</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kafka/kafka-with-zookeeper/">kafka with zookeeper</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kibana/">kibana</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/kibana/kibana-install/">kibana install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/logstash/">logstash</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/logstash/logstash-config-file/">logstash config file</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/logstash/logstash-filter-grok/">logstash filter grok</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/logstash/logstash-info/">logstash info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/logstash/logstash-install/">logstash install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/mycat/">mycat</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/mycat/mycat-jvm-optimize/">mycat jvm optimize</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/mycat/mycat-web-install/">mycat web install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/nsq/">nsq</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/nsq/nsq-command/">nsq command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/nsq/nsq-info/">nsq info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/nsq/nsq-install/">nsq install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/zookeeper/">zookeeper</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/zookeeper/zookeeper-install/">zookeeper install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/zookeeper/zookeeper-monitor/">zookeeper monitor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/zookeeper/zookeeper-optimize/">zookeeper optimize</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/zookeeper/zookeeper-use/">zookeeper use</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/zookeeper/zookeeper-zab-protocol/">zookeeper zab protocol</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-env/">java env</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-jvm-optimize/">java jvm optimize</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-jvm-opts/">java jvm opts</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-jvm-原理/">java jvm 原理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-learn/">java learn</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-learn/java-学习笔记/">java 学习笔记</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-log4j/">java log4j</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-performance-analysis/">java performance analysis</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/java-performance-analysis/jps/">jps</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/k8s-dashboard-install/">k8s dashboard install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/k8s-install/">k8s install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/k8s-registry-install/">k8s registry install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/node/node-install/">node install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/other/ACID/">ACID</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/分布式二阶段和三阶段提交协议/">分布式二阶段和三阶段提交协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/开源许可协议/">开源许可协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/网络带宽/">网络带宽</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/">system service</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/">Atlassian</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/confluence-https/">confluence https</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/confluence-install/">confluence install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/confluence-reset-passwd/">confluence reset passwd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/confluence-update/">confluence update</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/jira-https/">jira https</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/jira-install/">jira install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/jira-update/">jira update</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Atlassian/mariadb-install/">mariadb install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/">CentOS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/Base-env/">Base env</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-common-use-scripts/">linux common use scripts</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-history-info-setting/">linux history info setting</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-login-info/">linux login info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-nginx-install/">linux nginx install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-skill/">linux skill</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-system-init/">linux system init</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-内存插槽-内存信息/">linux 内存插槽 内存信息</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-扩容swap分区/">linux 扩容swap分区</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-物理CPU-CPU核数-逻辑CPU/">linux 物理CPU CPU核数 逻辑CPU</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-磁盘系统block区别/">linux 磁盘系统block区别</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/linux-设置-包含头文件路径-和-动态库链接路径/">linux 设置 包含头文件路径 和 动态库链接路径</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/CentOS/make提高源码编译速度/">make提高源码编译速度</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/NFS/">NFS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/NFS/nfs-exports-command/">nfs exports command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/NFS/nfs-install/">nfs install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Samba/">Samba</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Samba/samba-conf/">samba conf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/Samba/samba-install/">samba install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/">command</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/grep/">grep</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/pigz/">pigz</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/sed/">sed</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/split/">split</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/command/tr/">tr</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/haproxy/">haproxy</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/haproxy/haproxy-install/">haproxy install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/nginx/">nginx</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/nginx/nginx-install/">nginx install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/nginx/nginx-location/">nginx location</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/nginx/nginx-rewrite/">nginx rewrite</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/nginx/nginx-status/">nginx status</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/ntpd/">ntpd</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/ntpd/ntpd-install/">ntpd install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/openssl/">openssl</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/openssl/openssl-certificate/">openssl certificate</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/openvpn/">openvpn</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/openvpn/openvpn-install/">openvpn install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/rsync/">rsync</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/rsync/rsync-install/">rsync install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/supersord/">supersord</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/supersord/supersord-install/">supersord install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/vsftpd/">vsftpd</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/vsftpd/ftp-proxy/">ftp proxy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/vsftpd/vsftpd-error/">vsftpd error</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/vsftpd/vsftpd-info/">vsftpd info</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/vsftpd/vsftpd-install/">vsftpd install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/windows/">windows</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/windows/cygwin-install/">cygwin install</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/windows/ipsec-set/">ipsec set</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-service/windows/windows-modify-hosts/">windows modify hosts</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/SSL/">SSL</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/SSL/SSL-certificate/">SSL certificate</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/angular/">angular</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/angular/angular-install/">angular install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/hexo/">hexo</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/hexo/hexo-install/">hexo install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/sass/">sass</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/sass/sass-install/">sass install</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/xml/">xml</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/xml/xml-format/">xml format</a></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/01/hello-everyone/">Hello Everyone</a>
          </li>
        
          <li>
            <a href="/2017/11/28/kafka-web-console/">kafka web console</a>
          </li>
        
          <li>
            <a href="/2017/11/27/svn-auto-update/">svn auto update</a>
          </li>
        
          <li>
            <a href="/2017/11/15/salt-manage-event-reactor/">salt manage event reactor</a>
          </li>
        
          <li>
            <a href="/2017/11/15/salt-manage-job/">salt manage job</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 penn<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>